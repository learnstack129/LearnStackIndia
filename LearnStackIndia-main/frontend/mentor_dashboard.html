<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Dashboard - LearnStackIndia</title>
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'light'; 
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="mentor_dashboard.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        };
    </script>
    <style>
                /* frontend/mentor_dashboard.css */
          body {
              background-color: #f1f5f9;
              scroll-behavior: smooth;
          }
          
          .dark body {
              background-color: #0f172a;
              color: #e2e8f0;
          }
          
          .sidebar {
              width: 250px;
              transition: transform 0.3s ease-in-out;
          }
          
          .content {
              flex: 1;
          }
          
          /* Modal Styling */
          .modal {
              display: none; /* Hidden by default */
          }
          .modal.show {
              display: flex;
              animation: fadeIn 0.3s ease-out;
          }
          .modal-content-anim {
              animation: slideUp 0.3s ease-out;
          }
          
          @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
          }
          @keyframes slideUp {
              from { opacity: 0; transform: translateY(20px); }
              to { opacity: 1; transform: translateY(0); }
          }
          
          /* Loading Skeleton */
          .loading-skeleton {
              background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
              background-size: 200% 100%;
              animation: loading 1.5s infinite;
              border-radius: 0.5rem;
          }
          .dark .loading-skeleton {
              background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
              background-size: 200% 100%;
          }
          @keyframes loading {
              0% { background-position: 200% 0; }
              100% { background-position: -200% 0; }
          }
          
          /* Active Nav Link */
          .nav-link.active {
              font-weight: 600;
              color: #2563eb; /* text-blue-600 */
              background-color: #e5e7eb; /* bg-gray-200 */
          }
          .dark .nav-link.active {
              color: #60a5fa; /* text-blue-400 */
              background-color: #374151; /* dark:bg-gray-700 */
          }
          
          /* Table Responsive Styles */
          table { table-layout: fixed; width: 100%; }
          td, th { word-wrap: break-word; vertical-align: middle; }
          
          @media (max-width: 768px) {
              .content { margin-left: 0 !important; }
              thead { display: none; }
              tbody tr {
                  display: block;
                  margin-bottom: 1rem;
                  border: 1px solid #e5e7eb;
                  border-radius: 0.5rem;
                  padding: 0.5rem;
                  background-color: #fff;
              }
              .dark tbody tr {
                  border-color: #374151;
                  background-color: #1f2937;
              }
              tbody td {
                  display: block;
                  text-align: right;
                  padding-left: 50%;
                  position: relative;
                  border: none;
                  padding-top: 0.5rem;
                  padding-bottom: 0.5rem;
              }
              tbody td::before {
                  content: attr(data-label);
                  position: absolute;
                  left: 0.5rem;
                  width: calc(50% - 1rem);
                  padding-right: 0.5rem;
                  font-weight: bold;
                  text-align: left;
                  white-space: nowrap;
                  color: #6b7280;
              }
              .dark tbody td::before {
                  color: #9ca3af;
              }
              .actions-cell {
                  text-align: center !important;
                  padding-left: 0 !important;
                  width: 100%;
              }
              .actions-cell::before { display: none; }
          }
          
          /* Form Input Field */
          .input-field {
              padding: 0.5rem 0.75rem;
              border: 1px solid #d1d5db;
              border-radius: 0.375rem;
              background-color: #ffffff;
              color: #111827;
              box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
              transition: border-color 0.2s;
              width: 100%;
          }
          .dark .input-field {
              border-color: #4b5563;
              background-color: #374151;
              color: #f9fafb;
          }
          .input-field:focus {
              outline: none;
              border-color: #3b82f6;
              box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
          }
          
          /* Buttons */
          .btn-primary {
              padding: 0.5rem 1rem;
              background-color: #2563eb;
              color: white;
              font-weight: 500;
              border-radius: 0.375rem;
              box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
              transition: background-color 0.2s;
          }
          .btn-primary:hover {
              background-color: #1d4ed8;
          }
          .btn-primary:disabled {
              opacity: 0.5;
              cursor: not-allowed;
          }
          .btn-secondary {
              padding: 0.5rem 1rem;
              background-color: #e5e7eb;
              color: #111827;
              font-weight: 500;
              border-radius: 0.375rem;
              box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
              transition: background-color 0.2s;
          }
          .dark .btn-secondary {
              background-color: #4b5563;
              color: #f9fafb;
          }
          .btn-secondary:hover {
              background-color: #d1d5db;
          }
          .dark .btn-secondary:hover {
              background-color: #6b7280;
          }
          .btn-danger {
               padding: 0.25rem 0.5rem;
               background-color: #ef4444;
               color: white;
               font-size: 0.75rem;
               font-weight: 500;
               border-radius: 0.375rem;
               transition: background-color 0.2s;
          }
          .btn-danger:hover {
              background-color: #dc2626;
          }
          .btn-danger:disabled {
              opacity: 0.5;
              cursor: not-allowed;
          }
          
          /* Global Alert */
          #globalAlert button {
              background: none;
              border: none;
              color: inherit;
              font-size: 1.2em;
              cursor: pointer;
          }
    </style>
</head>
<body class="dark:bg-gray-900">
    <div class="flex h-screen bg-gray-100 dark:bg-gray-900 overflow-hidden">
        <aside class="sidebar bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-4 shadow-lg flex flex-col fixed inset-y-0 left-0 z-20 w-64 md:static transform -translate-x-full md:translate-x-0">
            <div class="text-2xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">
                <i class="fas fa-chalkboard-teacher mr-2"></i>Mentor Panel
            </div>
            <nav class="flex-grow">
                <ul>
                    <li class="mb-2"><a href="#my-tests" class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 active"><i class="fas fa-file-alt mr-2 w-4 inline-block text-center"></i>My Tests</a></li>
                    <li class="mb-2"><a href="#question-bank" class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-box mr-2 w-4 inline-block text-center"></i>Question Bank</a></li>
                    <li class="mb-2"><a href="#monitoring" class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-eye mr-2 w-4 inline-block text-center"></i>Live Monitoring</a></li>
                </ul>
            </nav>
            <div>
                <button id="mentorLogoutBtn" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600 mt-4 focus:outline-none focus:ring-2 focus:ring-red-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                </button>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-10 hidden md:hidden" onclick="toggleMobileMenu()"></div>

        <main class="content p-6 overflow-y-auto flex-1 md:ml-0">
            <button id="mobileMenuBtn" class="md:hidden fixed top-4 right-4 z-30 p-2 bg-white dark:bg-gray-700 rounded shadow focus:outline-none focus:ring-2 focus:ring-blue-300">
                <i class="fas fa-bars text-gray-600 dark:text-gray-300"></i>
            </button>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">Mentor Dashboard</h1>

            <section id="my-tests" class="mb-8 mentor-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">My Tests</h2>
                    <button onclick="openCreateTestModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <i class="fas fa-plus mr-1"></i> Create New Test
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Test Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Questions</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="question-bank" class="mb-8 mentor-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Question Bank (Coming Soon)</h2>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
                    <p class="text-gray-500 dark:text-gray-400">Manage all your questions here and add them to multiple tests.</p>
                </div>
            </section>

            <section id="monitoring" class="mb-8 mentor-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Live Monitoring</h2>
                <div class="mb-4">
                    <label for="monitorTestSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Test to Monitor:</label>
                    <select id="monitorTestSelect" class="input-field mt-1 w-full md:w-1/3">
                        <option value="">Loading tests...</option>
                    </select>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Strikes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monitoringTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Info">Select a test to see live attempts.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="createTestModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Create New Test</h3>
                    <button onclick="closeCreateTestModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form id="createTestForm" class="space-y-4 px-7 py-3">
                    <div>
                        <label for="newTestTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test Title*</label>
                        <input type="text" id="newTestTitle" required class="input-field">
                    </div>
                    <div>
                        <label for="newTestPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test Password*</label>
                        <input type="password" id="newTestPassword" required class="input-field">
                    </div>
                    <p id="createTestError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeCreateTestModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveTestBtn" type="button" class="btn-primary">Create Test</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="addQuestionModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
             <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="addQuestionModalTitle">Add Question</h3>
                    <button onclick="closeAddQuestionModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form id="addQuestionForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="addQuestionTestId">
                    <div>
                        <label for="questionText" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question Text*</label>
                        <textarea id="questionText" rows="3" required class="input-field"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="questionOption0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option 1*</label>
                            <input type="text" id="questionOption0" required class="input-field option-input">
                        </div>
                         <div>
                            <label for="questionOption1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option 2*</label>
                            <input type="text" id="questionOption1" required class="input-field option-input">
                        </div>
                         <div>
                            <label for="questionOption2" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option 3*</label>
                            <input type="text" id="questionOption2" required class="input-field option-input">
                        </div>
                         <div>
                            <label for="questionOption3" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option 4*</label>
                            <input type="text" id="questionOption3" required class="input-field option-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="correctAnswerIndex" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Correct Answer*</label>
                            <select id="correctAnswerIndex" required class="input-field">
                                <option value="" disabled selected>Select correct option</option>
                                <option value="0">Option 1</option>
                                <option value="1">Option 2</option>
                                <option value="2">Option 3</option>
                                <option value="3">Option 4</option>
                            </select>
                        </div>
                        <div>
                            <label for="questionTimeLimit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Limit (seconds)*</label>
                            <input type="number" id="questionTimeLimit" required class="input-field" value="90" min="10">
                        </div>
                    </div>
                    <p id="addQuestionError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeAddQuestionModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveQuestionBtn" type="button" class="btn-primary">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <div id="globalAlert" class="fixed bottom-5 right-5 z-50 hidden max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0">
        <p id="globalAlertMessage" class="mr-4"></p>
        <button onclick="hideGlobalAlert()" aria-label="Close alert">&times;</button>
    </div>

    <script>
              // frontend/mentor_dashboard.js
        const API_BASE_URL = '/api';
        let allMentorTests = []; // Cache for mentor's tests
        
        // --- UTILITIES ---
        function getAuthToken() { return localStorage.getItem('authToken'); }
        
        function checkMentorAuth() {
            const token = getAuthToken();
            const userStr = localStorage.getItem('currentUser');
            let userRole = null;
            if (userStr) { try { userRole = JSON.parse(userStr).role; } catch (e) { } }
            
            // Allow 'mentor' OR 'admin'
            if (!token || (userRole !== 'mentor' && userRole !== 'admin')) {
                console.warn("Not authenticated as mentor/admin, redirecting...");
                localStorage.clear();
                window.location.href = 'auth.html';
                return false;
            }
            return true;
        }
        
        async function makeMentorAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!checkMentorAuth()) return null;
        
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                const response = await fetch(`${API_BASE_URL}/mentor${endpoint}`, {
                    signal: controller.signal,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers },
                    ...options
                });
                clearTimeout(timeoutId);
                let data;
                try {
                    const text = await response.text();
                    data = text ? JSON.parse(text) : { success: response.ok };
                } catch (e) {
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${response.statusText}. Response not JSON.`);
                    return { success: true };
                }
                if (response.status === 401 || response.status === 403) {
                    checkMentorAuth(); // This will trigger redirect
                    return null;
                }
                if (!response.ok) throw new Error(data.message || `HTTP Error ${response.status}`);
                return data;
            } catch (error) {
                const message = error.name === 'AbortError' ? 'Request timed out.' : error.message;
                console.error(`API Error (${endpoint}):`, message, error);
                showGlobalAlert(`Error: ${message}`, 'error');
                return null;
            }
        }
        
        function showGlobalAlert(message, type = 'info') {
            const alertDiv = document.getElementById('globalAlert');
            const messageP = document.getElementById('globalAlertMessage');
            if (!alertDiv || !messageP) return;
            alertDiv.className = 'fixed bottom-5 right-5 z-50 max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0'; // Reset classes
            messageP.textContent = message;
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            alertDiv.classList.add(colors[type] || colors.info, 'text-white');
            alertDiv.classList.remove('hidden');
            void alertDiv.offsetWidth; // Force reflow
            alertDiv.classList.remove('opacity-0');
            if (alertDiv.alertTimeout) clearTimeout(alertDiv.alertTimeout);
            alertDiv.alertTimeout = setTimeout(hideGlobalAlert, 5000);
        }
        function hideGlobalAlert() {
            const alertDiv = document.getElementById('globalAlert');
            if (!alertDiv) return;
            alertDiv.classList.add('opacity-0');
            setTimeout(() => {
                alertDiv.classList.add('hidden');
                if (alertDiv.alertTimeout) { clearTimeout(alertDiv.alertTimeout); alertDiv.alertTimeout = null; }
            }, 300); // Match CSS transition duration
        }
        
        // --- NAVIGATION ---
        function handleNavigation() {
            const hash = window.location.hash || '#my-tests';
            const targetSectionId = hash.substring(1);
            document.querySelectorAll('.mentor-section').forEach(sec => sec.classList.add('hidden'));
            const targetSection = document.getElementById(targetSectionId) || document.getElementById('my-tests');
            targetSection.classList.remove('hidden');
            const sectionIdToShow = targetSection.id;
        
            document.querySelectorAll('.nav-link').forEach(link => { link.classList.remove('active'); if (link.getAttribute('href') === `#${sectionIdToShow}`) link.classList.add('active'); });
            closeMobileMenu();
            
            // Load data for the shown section if needed
            if(sectionIdToShow === 'my-tests') {
                loadMentorTests();
            }
            if(sectionIdToShow === 'monitoring') {
                populateMonitorTestSelect();
            }
        }
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar'), overlay = document.getElementById('overlay'), isOpen = sidebar.classList.contains('translate-x-0');
            sidebar.classList.toggle('-translate-x-full', isOpen); sidebar.classList.toggle('translate-x-0', !isOpen); overlay.classList.toggle('hidden', isOpen);
        }
        function closeMobileMenu() { document.querySelector('.sidebar').classList.add('-translate-x-full'); document.querySelector('.sidebar').classList.remove('translate-x-0'); document.getElementById('overlay').classList.add('hidden'); }
        function mentorLogout() { if (confirm('Logout?')) { localStorage.clear(); window.location.href = 'auth.html'; } }
        
        // --- "MY TESTS" SECTION ---
        async function loadMentorTests() {
            const tbody = document.getElementById('testsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            
            const data = await makeMentorAPICall('/tests');
            tbody.innerHTML = '';
        
            if (data?.success && data.tests) {
                allMentorTests = data.tests; // Cache the test data
                if (data.tests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No tests created yet.</td></tr>';
                    return;
                }
                data.tests.forEach(test => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    const questionCount = test.questions ? test.questions.length : 0;
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Title">${test.title}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${test.isActive ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300'}">${test.isActive ? 'Active' : 'Draft'}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Questions">${questionCount}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick="openAddQuestionModal('${test._id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 mr-3" title="Add Question"><i class="fas fa-plus"></i></button>
                            <button onclick="alert('Toggle active soon')" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 mr-3" title="Activate/Deactivate"><i class="fas fa-power-off"></i></button>
                            <button onclick="alert('Delete soon')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Delete Test"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load tests.</td></tr>';
            }
        }
        
        // --- Create Test Modal ---
        function openCreateTestModal() {
            document.getElementById('createTestForm').reset();
            document.getElementById('createTestError').textContent = '';
            document.getElementById('createTestModal').classList.add('show');
        }
        function closeCreateTestModal() {
            document.getElementById('createTestModal').classList.remove('show');
        }
        async function saveNewTest() {
            const title = document.getElementById('newTestTitle').value;
            const password = document.getElementById('newTestPassword').value;
            const errorP = document.getElementById('createTestError');
            const saveButton = document.getElementById('saveTestBtn');
            errorP.textContent = '';
            
            if (!title || !password) {
                errorP.textContent = 'Title and password are required.';
                return;
            }
            
            saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
            const result = await makeMentorAPICall('/tests', {
                method: 'POST',
                body: JSON.stringify({ title, password })
            });
            
            saveButton.disabled = false; saveButton.innerHTML = 'Create Test';
            
            if (result?.success) {
                showGlobalAlert('Test created!', 'success');
                closeCreateTestModal();
                loadMentorTests(); // Refresh the list
            } else {
                errorP.textContent = result?.message || 'Failed to create test.';
            }
        }
        
        // --- Add Question Modal ---
        function openAddQuestionModal(testId) {
            document.getElementById('addQuestionForm').reset();
            document.getElementById('addQuestionError').textContent = '';
            document.getElementById('addQuestionTestId').value = testId;
            const test = allMentorTests.find(t => t._id === testId);
            if(test) {
                document.getElementById('addQuestionModalTitle').textContent = `Add Question to: ${test.title}`;
            }
            document.getElementById('addQuestionModal').classList.add('show');
        }
        function closeAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.remove('show');
        }
        async function saveNewQuestion() {
            const testId = document.getElementById('addQuestionTestId').value;
            const errorP = document.getElementById('addQuestionError');
            const saveButton = document.getElementById('saveQuestionBtn');
            errorP.textContent = '';
        
            const questionData = {
                text: document.getElementById('questionText').value,
                options: [
                    document.getElementById('questionOption0').value,
                    document.getElementById('questionOption1').value,
                    document.getElementById('questionOption2').value,
                    document.getElementById('questionOption3').value,
                ],
                correctAnswerIndex: parseInt(document.getElementById('correctAnswerIndex').value, 10),
                timeLimit: parseInt(document.getElementById('questionTimeLimit').value, 10)
            };
            
            // Validation
            if (!questionData.text || questionData.options.some(opt => !opt) || isNaN(questionData.correctAnswerIndex) || isNaN(questionData.timeLimit)) {
                errorP.textContent = 'Please fill all required fields correctly.';
                return;
            }
        
            saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
            const result = await makeMentorAPICall(`/tests/${testId}/questions`, {
                method: 'POST',
                body: JSON.stringify(questionData)
            });
        
            saveButton.disabled = false; saveButton.innerHTML = 'Save Question';
        
            if (result?.success) {
                showGlobalAlert('Question added!', 'success');
                closeAddQuestionModal();
                loadMentorTests(); // Refresh test list to update question count
            } else {
                errorP.textContent = result?.message || 'Failed to add question.';
            }
        }
        
        // --- MONITORING SECTION ---
        async function populateMonitorTestSelect() {
            const select = document.getElementById('monitorTestSelect');
            select.innerHTML = '<option value="">Loading tests...</option>';
            
            // Use cached tests if available, otherwise fetch
            let testsToUse = allMentorTests;
            if (testsToUse.length === 0) {
                const data = await makeMentorAPICall('/tests');
                if (data?.success && data.tests) {
                    testsToUse = data.tests;
                    allMentorTests = data.tests; // Cache them
                }
            }
            
            select.innerHTML = '<option value="" disabled selected>Select a test</option>';
            if (testsToUse.length > 0) {
                testsToUse.forEach(test => {
                    const option = new Option(`${test.title} (${test.questions.length}Q)`, test._id);
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">No tests found</option>';
            }
        }
        
        async function loadTestAttempts() {
            const testId = document.getElementById('monitorTestSelect').value;
            if (!testId) return;
            
            const tbody = document.getElementById('monitoringTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            
            const data = await makeMentorAPICall(`/tests/${testId}/attempts`);
            tbody.innerHTML = '';
            
            if (data?.success && data.attempts) {
                if (data.attempts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No users have started this test yet.</td></tr>';
                    return;
                }
                
                data.attempts.forEach(attempt => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    
                    let statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
                    if (attempt.status === 'locked') {
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    } else if (attempt.status === 'completed') {
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    }
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="User">${attempt.username}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${attempt.status}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Strikes">${attempt.strikes} / 3</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            ${attempt.status === 'locked' ? 
                                `<button onclick="unlockUserAttempt('${attempt.userId}', '${attempt.attemptId}')" class="btn-danger">
                                    <i class="fas fa-unlock mr-1"></i>Unlock
                                 </button>` : 
                                '<span class="text-xs text-gray-400">No actions</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load attempts.</td></tr>';
            }
        }
        
        async function unlockUserAttempt(userId, attemptId) {
            if (!confirm('Are you sure you want to unlock this test for the user? Their strikes will be reset to 0.')) {
                return;
            }
            
            showGlobalAlert('Unlocking test...', 'info');
            
            const result = await makeMentorAPICall('/attempts/unlock', {
                method: 'POST',
                body: JSON.stringify({ userId, attemptId })
            });
            
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                loadTestAttempts(); // Refresh the monitoring list
            } else {
                // showGlobalAlert is already called on API error
            }
        }
        
        
        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkMentorAuth()) return; // Initial auth check
        
            // Setup Event Listeners
            document.getElementById('mentorLogoutBtn').addEventListener('click', mentorLogout);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', closeMobileMenu);
            
            // Create Test Modal
            document.getElementById('saveTestBtn').addEventListener('click', saveNewTest);
            document.getElementById('createTestModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeCreateTestModal(); });
        
            // Add Question Modal
            document.getElementById('saveQuestionBtn').addEventListener('click', saveNewQuestion);
            document.getElementById('addQuestionModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeAddQuestionModal(); });
            
            // Monitoring
            document.getElementById('monitorTestSelect').addEventListener('change', loadTestAttempts);
        
            // Initial Navigation
            window.addEventListener('hashchange', handleNavigation);
            handleNavigation(); // Load section based on initial hash
        });
        
        // Re-check auth on pageshow
        window.addEventListener('pageshow', function(event) {
            if (!checkMentorAuth()) {
                console.error("MENTOR PAGE: Auth check FAILED on pageshow.");
            }
        });
    </script>
</body>
</html>
