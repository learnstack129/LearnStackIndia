<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Visualizer - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        accent: '#f59e0b',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'bounce-gentle': 'bounceGentle 2s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        .shape:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { top: 20%; right: 10%; animation-delay: 2s; }
        .shape:nth-child(3) { bottom: 20%; left: 15%; animation-delay: 4s; }
        .shape:nth-child(4) { bottom: 10%; right: 15%; animation-delay: 1s; }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-effect {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .card-hover { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .dark .card-hover:hover { box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4); }

        .neon-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .dark .neon-glow { box-shadow: 0 0 20px rgba(147, 197, 253, 0.3); }

        .topic-icon { transition: all 0.3s ease; }
        .card-hover:hover .topic-icon { transform: scale(1.1) rotate(5deg); }

        .progress-ring {
            transition: stroke-dasharray 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            pointer-events: none;
            animation: floatParticle 20s infinite linear;
        }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        .hero-text {
            background: linear-gradient(135deg, #ccccd9 0%, #be8eef 50%, #eca2ec 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .text-6xl { line-height: 1.2; } /* Adjusted line-height for large text */
        .text-4xl { line-height: 1.2; } /* Added for smaller screens */


        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
            border: 1px solid rgba(147, 197, 253, 0.3);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* --- New Styles for Algorithm List --- */
        .algorithm-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .algorithm-card:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .dark .algorithm-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .hidden { display: none; } /* Ensure hidden class works */
        /* --- End New Styles --- */

        /* Responsive Navbar text */
        @media (max-width: 640px) {
            #welcomeText {
                display: none;
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 min-h-screen">
    <div class="floating-particles">
        </div>

    <nav class="bg-white dark:bg-gray-800 shadow-xl relative z-10 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div
                        class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        <i class="fas fa-code mr-2 text-blue-600"></i>
                        DSA Visualizer
                    </div>
                </div>

                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="themeToggle"
                        class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 neon-glow">
                        <i id="themeIcon" class="fas fa-moon text-lg"></i>
                    </button>

                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div class="flex items-center space-x-2">
                            <div
                                class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                <span id="userInitial">U</span>
                            </div>
                            <span id="welcomeText"
                                class="hidden sm:block text-gray-700 dark:text-gray-300 font-semibold truncate">Loading...</span>
                        </div>
                        <button id="logoutBtn"
                            class="bg-red-500 text-white px-2 py-2 sm:px-4 rounded-lg hover:bg-red-600 transition-all duration-300 shadow-lg hover:shadow-red-500/25 font-medium">
                            <i class="fas fa-sign-out-alt sm:mr-1"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="relative z-10">
        <section class="gradient-bg text-white py-16 sm:py-20 relative overflow-hidden">
             <div class="floating-shapes">
                <div class="shape w-32 h-32 bg-white rounded-full"></div>
                <div class="shape w-24 h-24 bg-blue-200 rounded-lg transform rotate-45"></div>
                <div class="shape w-20 h-20 bg-purple-200 rounded-full"></div>
                <div class="shape w-28 h-28 bg-pink-200 rounded-lg transform rotate-12"></div>
            </div>

            <div class="absolute inset-0 bg-black opacity-10"></div>
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-6xl font-bold mb-6 animate-fade-in hero-text">
                    Master Data Structures & Algorithms
                </h1>
                <p class="text-lg sm:text-xl mb-8 max-w-3xl mx-auto animate-slide-up opacity-90">
                    Interactive visualizations and step-by-step learning to help you understand complex algorithms
                </p>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 animate-slide-up">
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold" id="totalTopics">
                             <span class="loading-skeleton w-8 h-8 rounded inline-block"></span>
                        </div>
                        <div class="text-sm opacity-80">Topics Available</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold" id="totalAlgorithms">
                            <span class="loading-skeleton w-8 h-8 rounded inline-block"></span>
                        </div>
                        <div class="text-sm opacity-80">Algorithms</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold">Interactive</div>
                        <div class="text-sm opacity-80">Learning</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8 bg-gray-100 dark:bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Learning Progress</p>
                                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="learningProgress">
                                    <span class="loading-skeleton w-12 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div class="relative">
                                <svg class="w-12 h-12" id="progressRing">
                                    <circle cx="24" cy="24" r="20" fill="transparent" stroke="#e5e7eb" stroke-width="4">
                                    </circle>
                                    <circle cx="24" cy="24" r="20" fill="transparent" stroke="#3b82f6" stroke-width="4"
                                        stroke-dasharray="125.6" stroke-dashoffset="125.6" class="progress-ring"
                                        id="progressCircle"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <i class="fas fa-chart-line text-blue-600 text-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Algorithms Mastered</p>
                                <p class="text-2xl font-bold text-green-600 dark:text-green-400"
                                    id="algorithmsCompleted">
                                    <span class="loading-skeleton w-8 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-trophy text-green-600 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Time Spent Today</p>
                                <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="timeToday">
                                    <span class="loading-skeleton w-12 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-purple-600 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Current Rank</p>
                                <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="currentRank">
                                    <span class="loading-skeleton w-16 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-medal text-orange-600 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="subjectsSection" class="py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white mb-4 animate-fade-in">
                    Explore Subjects
                </h2>
                <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto animate-slide-up">
                    Choose a subject to start learning
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="subjectsGrid">
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
            </div>
        </section>

        <section id="topicsSection" class="hidden py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12 gap-4">
                <h2 id="topicListTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white animate-fade-in">
                    Topics
                </h2>
                <button id="backToSubjectsBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 font-medium self-start sm:self-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Subjects
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="topicsGrid">
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
            </div>
        </section>

        <section id="algorithmsSection" class="hidden py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12 gap-4">
                <h2 id="algorithmListTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white animate-fade-in">
                    Algorithms
                </h2>
                <button id="backToTopicsBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 font-medium self-start sm:self-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Topics
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="algorithmsGrid">
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
            </div>
        </section>


        <section class="py-16 bg-gray-100 dark:bg-gray-800">
             <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl animate-fade-in">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-route text-blue-600 mr-3"></i>
                            Your Learning Path
                        </h3>
                        <div class="space-y-4" id="learningPath">
                            <div class="loading-skeleton h-16 rounded-xl"></div>
                            <div class="loading-skeleton h-16 rounded-xl"></div>
                            <div class="loading-skeleton h-16 rounded-xl"></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl animate-fade-in">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-trophy text-yellow-600 mr-3"></i>
                            Recent Achievements
                        </h3>
                        <div class="grid grid-cols-2 gap-4" id="recentAchievements">
                            <div class="loading-skeleton h-24 rounded-xl"></div>
                            <div class="loading-skeleton h-24 rounded-xl"></div>
                            <div class="loading-skeleton h-24 rounded-xl"></div>
                            <div class="loading-skeleton h-24 rounded-xl"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-16">
           <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h3 class="text-3xl font-bold text-gray-800 dark:text-white mb-8 animate-fade-in">
                    Ready to Continue Learning?
                </h3>
                <div class="flex flex-col sm:flex-row flex-wrap justify-center gap-4">
                    <button id="continueCurrentTopic"
                        class="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-blue-500/25 hover:scale-105 transition-all duration-300 animate-fade-in">
                        <i class="fas fa-play mr-2"></i>
                        Continue Current Topic
                    </button>
                    <button id="randomChallenge"
                        class="w-full sm:w-auto bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-green-500/25 hover:scale-105 transition-all duration-300 animate-fade-in">
                        <i class="fas fa-random mr-2"></i>
                        Random Challenge
                    </button>
                    <button id="viewProgress"
                        class="w-full sm:w-auto bg-gradient-to-r from-purple-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-purple-500/25 hover:scale-105 transition-all duration-300 animate-fade-in">
                        <i class="fas fa-chart-line mr-2"></i>
                        View Progress
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Application state
        let currentUser = null;
        let dashboardData = null;
        let currentTopicsArray = []; // Store topics for the "back" button

        // API Configuration
        const API_BASE_URL = '/api';

        // Utility function to get auth token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // API call with authentication
        async function makeAuthenticatedAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                redirectToAuth();
                throw new Error("Authentication token not found.");
            }
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    },
                    ...options
                });
                clearTimeout(timeoutId);
                if (response.status === 401) {
                    redirectToAuth();
                    throw new Error("Authentication failed (401).");
                }
                const contentType = response.headers.get("content-type");
                let data;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { success: response.ok, message: text || `HTTP ${response.status}` };
                }
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('Request timeout. Please check your connection.', 'error');
                } else if (!error.message.includes("Authentication failed")) {
                    showAlert(`API Error: ${error.message}`, 'error');
                }
                throw error;
            }
        }

        // Theme Management
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            let currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme);
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                localStorage.setItem('theme', currentTheme);
            });
            function applyTheme(theme) {
                html.classList.toggle('dark', theme === 'dark');
                themeIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'} text-lg`;
            }
        }

        // Initialize user data from localStorage
        function initializeUser() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}`;
                    document.getElementById('userInitial').textContent = currentUser.username.charAt(0).toUpperCase();
                } catch (error) {
                    redirectToAuth();
                }
            } else {
                redirectToAuth();
            }
        }

        // Fetch dashboard data
        async function loadDashboardData() {
            showSkeletonLoaders();
            try {
                console.log('üîÑ Fetching dashboard data...');
                dashboardData = await makeAuthenticatedAPICall('/auth/dashboard');
                if (dashboardData) {
                    console.log('‚úÖ Dashboard data loaded:', dashboardData);
                    updateDashboardUI(dashboardData);
                } else {
                    showEmptyDashboard();
                }
            } catch (error) {
                console.error('‚ùå Critical error loading dashboard:', error);
                showEmptyDashboard();
            }
        }

        // Show loading skeletons
        function showSkeletonLoaders() {
            // Stats
            document.getElementById('learningProgress').innerHTML = `<span class="loading-skeleton w-12 h-6 rounded inline-block"></span>`;
            document.getElementById('algorithmsCompleted').innerHTML = `<span class="loading-skeleton w-8 h-6 rounded inline-block"></span>`;
            document.getElementById('timeToday').innerHTML = `<span class="loading-skeleton w-12 h-6 rounded inline-block"></span>`;
            document.getElementById('currentRank').innerHTML = `<span class="loading-skeleton w-16 h-6 rounded inline-block"></span>`;
            document.getElementById('totalTopics').innerHTML = `<span class="loading-skeleton w-8 h-8 rounded inline-block"></span>`;
            document.getElementById('totalAlgorithms').innerHTML = `<span class="loading-skeleton w-8 h-8 rounded inline-block"></span>`;
            updateProgressRing(0);
            // Subjects
            showDefaultSubjects();
            // Learning Path & Achievements
            showEmptyLearningPath();
            showEmptyAchievements();
        }

        // Update UI with real data
        function updateDashboardUI(data) {
            const stats = data?.stats || {};
            const user = data?.user || {};
            const rank = stats.rank || {};
            const achievements = data?.achievements || {};
            const learningPath = data?.learningPath;
            const subjectsData = data?.subjects || {}; // Use subjects data

            document.getElementById('welcomeText').textContent = `Welcome, ${user.username || 'User'}`;
            document.getElementById('userInitial').textContent = (user.username || 'U').charAt(0).toUpperCase();

            document.getElementById('learningProgress').textContent = `${stats.overallProgress ?? 0}%`;
            document.getElementById('algorithmsCompleted').textContent = stats.algorithmsCompleted ?? 0;
            document.getElementById('timeToday').textContent = formatTime(stats.timeToday ?? 0);
            document.getElementById('currentRank').textContent = rank.level ?? 'Bronze';

            // Update total counts based on new subjects structure
            const totalAlgoCount = stats.totalAlgorithms ?? '?';
            const totalTopicCount = Object.values(subjectsData).reduce((acc, topics) => acc + topics.length, 0) || '?';
            
            document.getElementById('totalAlgorithms').textContent = totalAlgoCount;
            document.getElementById('totalTopics').textContent = totalTopicCount;
           
            updateProgressRing(stats.overallProgress ?? 0);
            
            // Update subjects grid
            updateSubjectsGrid(subjectsData);

            // Update learning path (pass subjectsData to find topic info)
            updateLearningPath(learningPath, subjectsData);

            updateRecentAchievements(achievements);
        }

        // Show empty/default dashboard
        function showEmptyDashboard() {
            document.getElementById('learningProgress').textContent = '0%';
            document.getElementById('algorithmsCompleted').textContent = '0';
            document.getElementById('timeToday').textContent = '0m';
            document.getElementById('currentRank').textContent = 'Bronze';
            document.getElementById('totalAlgorithms').textContent = '?';
            document.getElementById('totalTopics').textContent = '?';
            updateProgressRing(0);
            showDefaultSubjects();
            showEmptyLearningPath();
            showEmptyAchievements();
        }

        // Format time helper
        function formatTime(minutes) {
            if (minutes === 0 || minutes === undefined || minutes === null) return '0m';
            if (minutes < 60) return `${Math.round(minutes)}m`;
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        // Update progress ring
        function updateProgressRing(percentage) {
            const circle = document.getElementById('progressCircle');
            if (!circle) return;
            const radius = circle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const validPercentage = Math.max(0, Math.min(100, percentage || 0));
            const offset = circumference - (validPercentage / 100 * circumference);
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            setTimeout(() => { circle.style.strokeDashoffset = offset; }, 50);
        }

        // --- LEVEL 1: SUBJECTS ---

        // Show default subject skeletons
        function showDefaultSubjects() {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = `<div class="loading-skeleton rounded-xl h-48"></div>`.repeat(4);
        }

        // Update subjects grid (NEW)
        function updateSubjectsGrid(subjects) {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '';
            const subjectNames = Object.keys(subjects);

            if (subjectNames.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No subjects available.</p>';
                return;
            }

            subjectNames.forEach(subjectName => {
                const topicsArray = subjects[subjectName];
                const card = createSubjectCard(subjectName, topicsArray);
                grid.appendChild(card);
            });
        }

        // Create a subject card (e.g., "DSA Visualizer")
        function createSubjectCard(subjectName, topicsArray) {
            const div = document.createElement('div');
            
            const representativeTopic = topicsArray.length > 0 ? topicsArray[0] : { icon: 'book', color: 'gray' };
            const topicCount = topicsArray.length;

            let totalCompletion = 0;
            let topicsWithProgress = 0;
            topicsArray.forEach(topic => {
                if (topic.completion > 0 || topic.status === 'completed') {
                    totalCompletion += topic.completion;
                    topicsWithProgress++;
                } else if (topic.status === 'in-progress') {
                    topicsWithProgress++;
                }
            });
            const subjectCompletion = topicsWithProgress > 0 ? Math.round(totalCompletion / topicsWithProgress) : 0;
            const isSubjectCompleted = topicsArray.every(t => t.status === 'completed');
            const isSubjectInProgress = !isSubjectCompleted && topicsArray.some(t => t.status === 'in-progress' || t.status === 'completed');

            let status, statusInfo;
            if (isSubjectCompleted) status = 'completed';
            else if (isSubjectInProgress) status = 'in-progress';
            else status = 'available';
            
            statusInfo = getStatusInfo(status);

            div.className = `card-hover bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 animate-fade-in group cursor-pointer`;
            
            div.innerHTML = `
                <div class="text-center mb-4 relative">
                    <div class="w-16 h-16 bg-${representativeTopic.color}-100 dark:bg-${representativeTopic.color}-900 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-${representativeTopic.icon} text-2xl text-${representativeTopic.color}-600 dark:text-${representativeTopic.color}-400 topic-icon"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-1">${subjectName}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${topicCount} ${topicCount === 1 ? 'Topic' : 'Topics'}</p>
                    ${subjectCompletion > 0 ? `<p class="text-xs text-gray-600 dark:text-gray-300 mt-1">${subjectCompletion}% Complete</p>` : ''}
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusInfo.class}">
                        <i class="fas ${statusInfo.icon} mr-1"></i>
                        ${statusInfo.text}
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => handleSubjectClick(subjectName, topicsArray));
            return div;
        }

        // Handle subject card click
        function handleSubjectClick(subjectName, topicsArray) {
            console.log("Subject clicked:", subjectName);
            currentTopicsArray = topicsArray; // Save for the 'back' button
            showTopicsList(subjectName, topicsArray);
        }

        // Show Subject List View
        function showSubjectsView() {
            document.getElementById('subjectsSection').classList.remove('hidden');
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('algorithmsSection').classList.add('hidden');
        }


        // --- LEVEL 2: TOPICS ---

        // Show list of topics (e.g., "Sorting", "Searching")
        function showTopicsList(subjectName, topicsArray) {
            const topicsSection = document.getElementById('topicsSection');
            const subjectsSection = document.getElementById('subjectsSection');
            const algorithmsSection = document.getElementById('algorithmsSection');
            const topicsGrid = document.getElementById('topicsGrid');
            const topicListTitle = document.getElementById('topicListTitle');

            topicListTitle.textContent = `${subjectName} Topics`;
            topicsGrid.innerHTML = ''; // Clear previous

            if (!topicsArray || topicsArray.length === 0) {
                topicsGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No topics found for this subject.</p>';
            } else {
                topicsArray.forEach(topic => {
                    const card = createTopicCard(topic); // Create the topic card
                    topicsGrid.appendChild(card);
                });
            }

            subjectsSection.classList.add('hidden');
            algorithmsSection.classList.add('hidden');
            topicsSection.classList.remove('hidden');
        }

        // Create a topic card (e.g., "Sorting")
        function createTopicCard(topic) {
            const div = document.createElement('div');
            const isLocked = topic.status === 'locked';

            div.className = `algorithm-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md border border-gray-200 dark:border-gray-700 flex items-center justify-between animate-fade-in ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-lg hover:border-blue-300 dark:hover:border-blue-600'}`;

            const statusInfo = getStatusInfo(topic.status);
            const algoCount = topic.algorithms.length;

            div.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${topic.name}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${algoCount} ${algoCount === 1 ? 'Algorithm' : 'Algorithms'}</p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                        <i class="fas ${statusInfo.icon} mr-1"></i>
                        ${statusInfo.text}
                    </div>
                    ${topic.completion > 0 ? `<span class="text-xs text-blue-600 dark:text-blue-400 block mt-1">${topic.completion}%</span>` : ''}
                </div>
            `;

            if (!isLocked) {
                div.addEventListener('click', () => handleTopicClick(topic));
            } else {
                div.setAttribute('title', 'This topic is currently locked.');
            }
            return div;
        }
        
        // Handle topic card click
        function handleTopicClick(topic) {
            console.log("Topic clicked:", topic.id, "Status:", topic.status);
            if (topic.status === 'locked') {
                showAlert('This topic is locked. Complete prerequisites to unlock it!', 'warning');
            } else {
                showAlgorithmList(topic);
            }
        }

        // Show Topic List View (for back button from algorithms)
        function showTopicsView() {
            document.getElementById('subjectsSection').classList.add('hidden');
            document.getElementById('topicsSection').classList.remove('hidden');
            document.getElementById('algorithmsSection').classList.add('hidden');
        }

        // --- LEVEL 3: ALGORITHMS ---

        // Show list of algorithms (e.g., "Bubble Sort", "Selection Sort")
        function showAlgorithmList(topic) {
            const topicsSection = document.getElementById('topicsSection');
            const algorithmsSection = document.getElementById('algorithmsSection');
            const algorithmsGrid = document.getElementById('algorithmsGrid');
            const algorithmListTitle = document.getElementById('algorithmListTitle');

            algorithmListTitle.textContent = `${topic.name} Algorithms`;
            algorithmsGrid.innerHTML = '';

            if (!topic.algorithms || topic.algorithms.length === 0) {
                algorithmsGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No algorithms found for this topic.</p>';
            } else {
                topic.algorithms.forEach(algoDef => {
                    const algoProgress = topic.userAlgoProgress[algoDef.id] || { completed: false, accuracyPractice: 0, attemptsPractice: 0 };
                    const card = createAlgorithmCard(topic.id, algoDef, algoProgress);
                    algorithmsGrid.appendChild(card);
                });
            }

            topicsSection.classList.add('hidden');
            algorithmsSection.classList.remove('hidden');
        }

        // Create an algorithm card (e.g., "Bubble Sort")
        function createAlgorithmCard(topicId, algoDef, algoProgress) {
            const div = document.createElement('div');
            const effectiveStatus = algoProgress.effectiveStatus || 'available';
            const isLocked = effectiveStatus === 'locked';

            div.className = `algorithm-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md border border-gray-200 dark:border-gray-700 flex items-center justify-between animate-fade-in ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-lg hover:border-blue-300 dark:hover:border-blue-600'}`;

            const isCompleted = algoProgress.completed === true;
            const statusIcon = isLocked
                ? '<i class="fas fa-lock text-red-500 ml-2" title="Locked"></i>'
                : (isCompleted
                    ? '<i class="fas fa-check-circle text-green-500 ml-2" title="Completed"></i>'
                    : '<i class="far fa-circle text-gray-400 ml-2" title="Not Completed"></i>');

            const attemptsPractice = algoProgress.attemptsPractice || 0;
            const accuracyPractice = algoProgress.accuracyPractice || 0;
            const accuracyText = attemptsPractice > 0 ? `<span class="text-xs text-blue-600 dark:text-blue-400">${accuracyPractice.toFixed(0)}%</span>` : '';

            div.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${algoDef.name} ${statusIcon}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${(algoDef.description || '').substring(0, 40)}...</p>
                </div>
                <div class="text-right">
                    <span class="text-xs font-medium px-2 py-0.5 rounded ${getDifficultyClass(algoDef.difficulty)}">${algoDef.difficulty}</span>
                    ${accuracyText}
                </div>
            `;

            if (!isLocked) {
                div.addEventListener('click', () => handleAlgorithmClick(topicId, algoDef.id));
            } else {
                div.setAttribute('title', 'This algorithm is currently locked.');
            }
            return div;
        }

        // Handle algorithm card click (navigates to the page)
        function handleAlgorithmClick(topicId, algorithmId) {
            const filePath = `topics/${algorithmId}/index.html`;
            console.log(`Navigating to: ${filePath}`);
            window.location.href = filePath;
        }


        // --- SHARED HELPER FUNCTIONS ---

        // Get status info (shared by subjects and topics)
        function getStatusInfo(status) {
            switch (status) {
                case 'available': return { class: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300', icon: 'fa-check', text: 'Available' };
                case 'in-progress': return { class: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300', icon: 'fa-hourglass-half', text: 'In Progress' };
                case 'completed': return { class: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300', icon: 'fa-trophy', text: 'Completed' };
                default: return { class: 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400', icon: 'fa-lock', text: 'Locked' };
            }
        }

        // Get difficulty class (shared by topics and algorithms)
        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case 'easy': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                case 'hard': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                case 'beginner': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                case 'intermediate': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                case 'advanced': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
            }
        }

        // --- LEARNING PATH & ACHIEVEMENTS ---

        // Update learning path
        function updateLearningPath(learningPath, subjectsData) {
            const container = document.getElementById('learningPath');
            container.innerHTML = '';
            if (!learningPath || !learningPath.currentTopic || !subjectsData) {
                showEmptyLearningPath();
                return;
            }

            const currentTopicId = learningPath.currentTopic;
            let currentTopicData = null;

            // Find the current topic data from within the subjects object
            for (const subjectName in subjectsData) {
                const foundTopic = subjectsData[subjectName].find(t => t.id === currentTopicId);
                if (foundTopic) {
                    currentTopicData = foundTopic;
                    break;
                }
            }

            if (!currentTopicData) {
                showEmptyLearningPath();
                console.warn(`Current topic ${currentTopicId} not found in subjectsData.`);
                return;
            }

            if (!currentTopicData.algorithms || !currentTopicData.userAlgoProgress) {
                showEmptyLearningPath();
                return;
            }

            const allAlgoDefs = currentTopicData.algorithms;
            const userAlgoProgressMap = currentTopicData.userAlgoProgress;

            let nextAlgDef = allAlgoDefs.find(def => {
                const progress = userAlgoProgressMap[def.id];
                return !progress || progress.completed !== true;
            });

            if (!nextAlgDef && allAlgoDefs.length > 0) {
                nextAlgDef = allAlgoDefs[allAlgoDefs.length - 1];
            }

            if (nextAlgDef) {
                const algProgress = userAlgoProgressMap[nextAlgDef.id] || { attemptsPractice: 0, accuracyPractice: 0, completed: false };
                const status = algProgress.completed ? 'completed' : 'in-progress';
                container.appendChild(createLearningPathItem(currentTopicId, nextAlgDef, algProgress, status));
            } else {
                showEmptyLearningPath();
            }
        }

        // Create learning path item
        function createLearningPathItem(topicId, algorithmDef, algProgress, status) {
            const div = document.createElement('div');
            let iconHtml, textHtml, statusClass, borderColor;
            if (status === 'completed') {
                statusClass = 'bg-green-50 dark:bg-green-900/20';
                borderColor = 'border-green-500';
                iconHtml = `<div class="flex-shrink-0 w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold"><i class="fas fa-check text-sm"></i></div>`;
                textHtml = `
                    <h4 class="font-semibold text-gray-800 dark:text-white">${algorithmDef.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Completed${algProgress.accuracyPractice ? ` with ${algProgress.accuracyPractice.toFixed(0)}% accuracy` : ''}</p>`;
            } else {
                statusClass = 'bg-yellow-50 dark:bg-yellow-900/20';
                borderColor = 'border-yellow-500';
                iconHtml = `<div class="flex-shrink-0 w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold"><i class="fas fa-play text-sm"></i></div>`;
                const attempts = algProgress.attemptsPractice || 0;
                textHtml = `
                    <h4 class="font-semibold text-gray-800 dark:text-white">${algorithmDef.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Next up${attempts > 0 ? ` - ${attempts} attempts` : ''}</p>`;
            }
            div.className = `flex items-center p-4 rounded-xl border-l-4 ${statusClass} ${borderColor} cursor-pointer hover:shadow-md transition-shadow`;
            div.innerHTML = `${iconHtml}<div class="ml-4 flex-1">${textHtml}</div><div class="text-gray-400 hover:text-blue-500"><i class="fas fa-chevron-right"></i></div>`;
            div.addEventListener('click', () => handleAlgorithmClick(topicId, algorithmDef.id));
            return div;
        }

        // Show empty learning path
        function showEmptyLearningPath() {
            document.getElementById('learningPath').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-route text-4xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">Start learning to see your progress here!</p>
                </div>`;
        }

        // Update recent achievements
        function updateRecentAchievements(achievements) {
            const container = document.getElementById('recentAchievements');
            container.innerHTML = '';
            if (!achievements || !achievements.recent || achievements.recent.length === 0) {
                showEmptyAchievements();
                return;
            }
            achievements.recent.slice(0, 4).forEach(ach => container.appendChild(createAchievementCard(ach)));
        }

        // Create achievement card
        function createAchievementCard(achievement) {
            const div = document.createElement('div');
            div.className = 'text-center p-4 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-xl';
            const iconClass = getAchievementIcon(achievement.icon);
            const colorClass = getAchievementColor(achievement.category);
            div.innerHTML = `
                <div class="w-12 h-12 ${colorClass} rounded-full flex items-center justify-center text-white mx-auto mb-2 animate-bounce-gentle">
                    <i class="fas ${iconClass}"></i>
                </div>
                <h4 class="font-bold text-gray-800 dark:text-white text-sm">${achievement.name}</h4>
                <p class="text-xs text-gray-600 dark:text-gray-400">${(achievement.description || '').substring(0, 40)}...</p>
            `;
            return div;
        }

        // Get achievement icon
        function getAchievementIcon(icon) {
            const iconMap = { search: 'fa-search', 'bar-chart': 'fa-chart-bar', layers: 'fa-layer-group', 'arrow-right': 'fa-arrow-right', link: 'fa-link', tree: 'fa-tree', network: 'fa-project-diagram', hash: 'fa-hashtag', compass: 'fa-compass', user: 'fa-user', 'book-open': 'fa-book-open', crown: 'fa-crown', zap: 'fa-bolt', flash: 'fa-bolt-lightning', target: 'fa-bullseye', award: 'fa-award', cpu: 'fa-microchip', 'check-circle': 'fa-check-circle', star: 'fa-star', calendar: 'fa-calendar-alt', flame: 'fa-fire', infinity: 'fa-infinity', clock: 'fa-clock', hourglass: 'fa-hourglass-half', medal: 'fa-medal', trophy: 'fa-trophy', gem: 'fa-gem', diamond: 'fa-diamond', 'dollar-sign': 'fa-dollar-sign', coins: 'fa-coins', moon: 'fa-moon', sunrise: 'fa-sun', weekend: 'fa-calendar-week', refresh: 'fa-sync-alt', 'check-square': 'fa-check-square', 'log-in': 'fa-sign-in-alt', 'user-check': 'fa-user-check' };
            return iconMap[icon] || 'fa-star';
        }

        // Get achievement color
        function getAchievementColor(category) {
            const colorMap = { 'learning': 'bg-blue-500', 'performance': 'bg-green-500', 'consistency': 'bg-purple-500', 'mastery': 'bg-yellow-500', 'special': 'bg-indigo-500' };
            return colorMap[category] || 'bg-gray-500';
        }

        // Show empty achievements
        function showEmptyAchievements() {
            document.getElementById('recentAchievements').innerHTML = `
                <div class="col-span-2 text-center py-8">
                    <i class="fas fa-trophy text-4xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">Complete algorithms to earn achievements!</p>
                </div>`;
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            alert(message); // Simple alert
        }

        // Redirect to auth page
        function redirectToAuth() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'auth.html';
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                redirectToAuth();
            }
        }

        // Create floating particles
        function createParticles() {
            const particleContainer = document.querySelector('.floating-particles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 20 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.opacity = Math.random() * 0.1 + 0.05;
                particleContainer.appendChild(particle);
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            window.addEventListener('pageshow', function(event) {
                if (!getAuthToken()) { redirectToAuth(); }
            });
            const token = getAuthToken();
            if (!token) { redirectToAuth(); return; }

            initializeTheme();
            initializeUser();
            createParticles();

            await loadDashboardData();

            // Event listeners
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('backToSubjectsBtn').addEventListener('click', showSubjectsView);
            document.getElementById('backToTopicsBtn').addEventListener('click', () => showTopicsList(document.getElementById('topicListTitle').textContent.replace(' Topics', ''), currentTopicsArray));


            // Quick action buttons
            document.getElementById('continueCurrentTopic').addEventListener('click', () => {
                if (dashboardData?.learningPath?.currentTopic && dashboardData?.subjects) {
                    const currentTopicId = dashboardData.learningPath.currentTopic;
                    let currentTopicData = null;
                    // Find the topic in the subjects data
                    for (const subjectName in dashboardData.subjects) {
                        const foundTopic = dashboardData.subjects[subjectName].find(t => t.id === currentTopicId);
                        if (foundTopic) {
                            currentTopicData = foundTopic;
                            break;
                        }
                    }
                    
                    if (currentTopicData && currentTopicData.algorithms?.length > 0 && currentTopicData.userAlgoProgress) {
                        const allAlgoDefs = currentTopicData.algorithms;
                        const userAlgoProgressMap = currentTopicData.userAlgoProgress;
                        let nextAlgDef = allAlgoDefs.find(def => {
                            const progress = userAlgoProgressMap[def.id];
                            return !progress || progress.completed !== true;
                        });
                        if (!nextAlgDef && allAlgoDefs.length > 0) { nextAlgDef = allAlgoDefs[0]; }
                        if (nextAlgDef) {
                            handleAlgorithmClick(currentTopicId, nextAlgDef.id);
                        } else { showAlert('Could not determine the next algorithm.', 'info'); }
                    } else { showAlert('Current topic has no algorithms or data is missing.', 'info'); }
                } else { showAlert('Learning path not set or data not loaded.', 'warning'); }
            });

            document.getElementById('randomChallenge').addEventListener('click', () => {
                showAlert('Random challenge feature coming soon!', 'info');
            });

            document.getElementById('viewProgress').addEventListener('click', () => {
                showAlert('Detailed progress overview coming soon!', 'info');
            });

            console.log("Dashboard initialized.");
        });
    </script>
</body>
</html>
