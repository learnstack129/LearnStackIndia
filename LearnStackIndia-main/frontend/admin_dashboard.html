<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DSA Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { /* Add extensions if needed */ }
            }
        };
    </script>
    <style>
        body {
            background-color: #f1f5f9;
            scroll-behavior: smooth;
        }

        .dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .sidebar {
            width: 250px;
            transition: transform 0.3s ease-in-out;
        }

        .content {
            flex: 1;
        }

        .modal {
            display: none;
            /* Hidden by default */
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        /* Use flex for centering */
        .modal-content-anim {
            animation: slideUp 0.3s ease-out;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.5rem;
            /* Add rounding */
        }

        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Active link style */
        .nav-link.active {
            font-weight: 600;
            color: #2563eb;
            /* text-blue-600 */
            background-color: #e5e7eb;
            /* bg-gray-200 */
        }

        .dark .nav-link.active {
            color: #60a5fa;
            /* text-blue-400 */
            background-color: #374151;
            /* dark:bg-gray-700 */
        }

        /* Ensure table content doesn't break layout */
        table {
            table-layout: fixed;
            width: 100%;
        }

        td,
        th {
            word-wrap: break-word;
            vertical-align: middle;
        }

        .actions-cell {
            width: 100px;
        }

        /* Fixed width for actions */
        /* Global Alert Styling */
        #globalAlert button {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            .content {
                margin-left: 0 !important;
            }

            /* Adjust content margin when sidebar is hidden */
            thead {
                display: none;
            }

            tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                dark: border-gray-700;
                border-radius: 0.5rem;
                padding: 0.5rem;
                background-color: #fff;
                dark: bg-gray-800;
            }

            tbody td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: calc(50% - 1rem);
                padding-right: 0.5rem;
                font-weight: bold;
                text-align: left;
                white-space: nowrap;
                color: #6b7280;
                /* text-gray-500 */
            }

            .dark tbody td::before {
                color: #9ca3af;
                /* dark:text-gray-400 */
            }

            .actions-cell {
                text-align: center !important;
                padding-left: 0 !important;
            }

            .actions-cell::before {
                display: none;
            }

            /* Hide label for actions */
            .pagination-container {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Input field styles for modals */
        .input-field {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #111827;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s;
            width: 100%;
        }

        .dark .input-field {
            border-color: #4b5563;
            background-color: #374151;
            color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .input-field[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .dark .input-field[readonly] {
            background-color: #4b5563;
        }
    </style>
</head>

<body class="dark:bg-gray-900">
    <div class="flex h-screen bg-gray-100 dark:bg-gray-900 overflow-hidden">
        <aside
            class="sidebar bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-4 shadow-lg flex flex-col fixed inset-y-0 left-0 z-20 w-64 md:static transform -translate-x-full md:translate-x-0">
            <div class="text-2xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">
                <i class="fas fa-user-shield mr-2"></i>Admin Panel
            </div>
            <nav class="flex-grow">
                <ul>
                    <li class="mb-2"><a href="#overview"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-tachometer-alt mr-2 w-4 inline-block text-center"></i>Overview</a></li>
                    <li class="mb-2"><a href="#users"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-users mr-2 w-4 inline-block text-center"></i>Users</a></li>
                    <li class="mb-2"><a href="#topics"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-book mr-2 w-4 inline-block text-center"></i>Topics</a></li>
                    <li class="mb-2"><a href="#achievements"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-trophy mr-2 w-4 inline-block text-center"></i>Achievements</a></li>
                    <li class="mb-2"><a href="#settings"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-cog mr-2 w-4 inline-block text-center"></i>Settings</a></li>
                </ul>
            </nav>
            <div>
                <button id="adminLogoutBtn"
                    class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600 mt-4 focus:outline-none focus:ring-2 focus:ring-red-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                </button>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-10 hidden md:hidden" onclick="toggleMobileMenu()">
        </div>

        <main class="content p-6 overflow-y-auto flex-1 md:ml-0">
            <button id="mobileMenuBtn"
                class="md:hidden fixed top-4 right-4 z-30 p-2 bg-white dark:bg-gray-700 rounded shadow focus:outline-none focus:ring-2 focus:ring-blue-300">
                <i class="fas fa-bars text-gray-600 dark:text-gray-300"></i>
            </button>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">Admin Dashboard</h1>

            <section id="overview" class="mb-8 admin-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="statsContainer">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow loading-skeleton h-24"></div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow loading-skeleton h-24"></div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow loading-skeleton h-24"></div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow loading-skeleton h-24"></div>
                </div>
            </section>

            <section id="users" class="mb-8 admin-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">User Management</h2>
                <div class="mb-4">
                    <input type="text" id="userSearchInput" placeholder="Search by username or email..."
                        class="w-full md:w-1/3 px-4 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th data-sort="username"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Username <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th data-sort="email"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Email <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th data-sort="rank"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Rank <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th data-sort="points"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Points <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th data-sort="role"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Role <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Verified</th>
                                    <th data-sort="createdAt"
                                        class="cursor-pointer px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                        Joined <i class="fas fa-sort opacity-50 ml-1"></i>
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="6" class="p-4" data-label="Loading">
                                        <div class="loading-skeleton h-8 w-full"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0 p-4 border-t border-gray-200 dark:border-gray-700 pagination-container"
                        id="userPagination">
                        <span class="text-sm text-gray-700 dark:text-gray-400">Loading...</span>
                        <div></div>
                    </div>
                </div>
            </section>

            <section id="topics" class="mb-8 admin-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Topic Management</h2>
                    <button onclick="openEditTopicModal()"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <i class="fas fa-plus mr-1"></i> Add Topic
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Order</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-2/12">
                                        ID</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-3/12">
                                        Name</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-2/12">
                                        Difficulty</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Active</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell w-2/12">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="topicsTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="6" class="p-4" data-label="Loading">
                                        <div class="loading-skeleton h-8 w-full"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="achievements" class="mb-8 admin-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Achievement Management</h2>
                    <button onclick="openEditAchievementModal()"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <i class="fas fa-plus mr-1"></i> Add Achievement
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-2/12">
                                        ID</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-3/12">
                                        Name</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Category</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Points</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Rarity</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/12">
                                        Active</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell w-2/12">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="achievementsTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="7" class="p-4" data-label="Loading">
                                        <div class="loading-skeleton h-8 w-full"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="settings" class="mb-8 admin-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Settings & Actions</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
                    <div>
                        <h3 class="text-lg font-medium mb-2">Leaderboard</h3>
                        <button id="regenerateLeaderboardBtn"
                            class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300 disabled:opacity-50">
                            <i class="fas fa-sync-alt mr-2"></i>Regenerate All-Time Leaderboard
                        </button>
                        <p id="settingsStatus" class="mt-2 text-sm h-4"></p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="editUserModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modalTitle">Edit User
                    </h3>
                    <button id="closeUserModalBtnTop"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mt-2 px-7 py-3">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-4 text-left">
                            <label for="editUserRole"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role</label>
                            <select id="editUserRole" class="input-field mt-1">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-4 text-left">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email
                                Verified</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input id="editUserVerifiedTrue" name="isEmailVerified" type="radio" value="true"
                                        class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-500">
                                    <label for="editUserVerifiedTrue"
                                        class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">Verified</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="editUserVerifiedFalse" name="isEmailVerified" type="radio" value="false"
                                        class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-500">
                                    <label for="editUserVerifiedFalse"
                                        class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">Not
                                        Verified</label>
                                </div>
                            </div>
                        </div>
                        <p id="editUserError" class="text-red-500 text-sm mt-2 h-4"></p>
                    </form>
                </div>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button id="closeUserModalBtn" type="button"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button id="saveUserChangesBtn" type="button"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editTopicModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="topicModalTitle">
                        Add/Edit Topic</h3>
                    <button id="closeTopicModalBtnTop"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editTopicForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="editTopicId"> {/* Stores MongoDB _id for updates */}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editTopicIdInput"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Topic ID (e.g.,
                                'searching')*</label>
                            <input type="text" id="editTopicIdInput" required class="input-field">
                        </div>
                        <div>
                            <label for="editTopicName"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name*</label>
                            <input type="text" id="editTopicName" required class="input-field">
                        </div>
                        <div>
                            <label for="editTopicOrder"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Order*</label>
                            <input type="number" id="editTopicOrder" required class="input-field">
                        </div>
                        <div>
                            <label for="editTopicEstTime"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimated Time
                                (hrs)*</label>
                            <input type="number" id="editTopicEstTime" required class="input-field">
                        </div>
                        <div>
                            <label for="editTopicIcon"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Icon
                                (FontAwesome class)</label>
                            <input type="text" id="editTopicIcon" class="input-field" placeholder="e.g., fa-search">
                        </div>
                        <div>
                            <label for="editTopicColor"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color (Tailwind
                                prefix)</label>
                            <input type="text" id="editTopicColor" class="input-field" placeholder="e.g., blue">
                        </div>
                        <div>
                            <label for="editTopicDifficulty"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Difficulty*</label>
                            <select id="editTopicDifficulty" required class="input-field">
                                <option value="" disabled selected>Select Difficulty</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div>
                            <label for="editTopicIsActive"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <select id="editTopicIsActive" class="input-field">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="editTopicDesc"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                        <textarea id="editTopicDesc" rows="3" class="input-field"></textarea>
                    </div>

                    <div class="md:col-span-2 border-t dark:border-gray-600 pt-4 mt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300">Algorithms in this Topic
                            </h4>
                            <button type="button" onclick="openEditAlgorithmModal()"
                                class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                                <i class="fas fa-plus mr-1"></i> Add Algorithm
                            </button>
                        </div>
                        <div id="topicAlgorithmsList"
                            class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
                            <p class="text-center text-gray-500 dark:text-gray-400 text-sm italic">No algorithms added
                                yet.</p>
                        </div>
                        {/* Hidden input to store algorithm data (optional, kept for potential future use) */}
                        <input type="hidden" id="topicAlgorithmsData" value="[]">
                    </div>
                    <p id="editTopicError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button id="closeTopicModalBtn" type="button"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button id="saveTopicChangesBtn" type="button"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editAlgorithmModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-[60]">
        {/* Higher z-index */}
        <div
            class="relative mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="algorithmModalTitle">Add
                        Algorithm</h3>
                    <input type="hidden" id="editAlgorithmIndex"> {/* To track which algorithm is being edited */}
                    <button id="closeAlgorithmModalBtnTop"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editAlgorithmForm" class="space-y-4 px-7 py-3 max-h-[60vh] overflow-y-auto">
                    {/* Algorithm Fields */}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editAlgoIdInput"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Algorithm ID*
                                <small>(e.g., 'bubbleSort')</small></label>
                            <input type="text" id="editAlgoIdInput" required class="input-field">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Must match the folder name in
                                `frontend/topics/`</p>
                        </div>
                        <div>
                            <label for="editAlgoName"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name*
                                <small>(e.g., 'Bubble Sort')</small></label>
                            <input type="text" id="editAlgoName" required class="input-field">
                        </div>
                        <div>
                            <label for="editAlgoDifficulty"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Difficulty*</label>
                            <select id="editAlgoDifficulty" required class="input-field">
                                <option value="" disabled selected>Select Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label for="editAlgoPoints"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Points*</label>
                            <input type="number" id="editAlgoPoints" required class="input-field">
                        </div>
                        <div class="md:col-span-2">
                            <label for="editAlgoDesc"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                            <textarea id="editAlgoDesc" rows="2" class="input-field"></textarea>
                        </div>
                        {/* Optional: Add fields for time/space complexity, prerequisites if needed */}
                        <div>
                            <label for="editAlgoTimeComplexity"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Complexity
                                <small>(e.g., 'O(n²)')</small></label>
                            <input type="text" id="editAlgoTimeComplexity" class="input-field">
                        </div>
                        <div>
                            <label for="editAlgoSpaceComplexity"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Space Complexity
                                <small>(e.g., 'O(1)')</small></label>
                            <input type="text" id="editAlgoSpaceComplexity" class="input-field">
                        </div>
                    </div>
                    <p id="editAlgoError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button id="closeAlgorithmModalBtn" type="button"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button id="saveAlgorithmChangesBtn" type="button"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50">
                        Save Algorithm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editAchievementModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="achievementModalTitle">
                        Add/Edit Achievement</h3>
                    <button id="closeAchievementModalBtnTop"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editAchievementForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="editAchievementId"> {/* Stores MongoDB _id for updates */}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editAchIdInput"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Achievement ID
                                (e.g., 'search_master')*</label>
                            <input type="text" id="editAchIdInput" required class="input-field">
                        </div>
                        <div>
                            <label for="editAchName"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name*</label>
                            <input type="text" id="editAchName" required class="input-field">
                        </div>
                        <div>
                            <label for="editAchIcon"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Icon
                                (FontAwesome class)*</label>
                            <input type="text" id="editAchIcon" required class="input-field"
                                placeholder="e.g., fa-search">
                        </div>
                        <div>
                            <label for="editAchCategory"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category*</label>
                            <select id="editAchCategory" required class="input-field">
                                <option value="" disabled selected>Select Category</option>
                                <option value="learning">Learning</option>
                                <option value="performance">Performance</option>
                                <option value="consistency">Consistency</option>
                                <option value="mastery">Mastery</option>
                                <option value="special">Special</option>
                            </select>
                        </div>
                        <div>
                            <label for="editAchPoints"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Points*</label>
                            <input type="number" id="editAchPoints" required class="input-field">
                        </div>
                        <div>
                            <label for="editAchRarity"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rarity</label>
                            <select id="editAchRarity" class="input-field">
                                <option value="common">Common</option>
                                <option value="rare">Rare</option>
                                <option value="epic">Epic</option>
                                <option value="legendary">Legendary</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="editAchDesc"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description*</label>
                            <textarea id="editAchDesc" rows="2" required class="input-field"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="editAchCriteria"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Criteria (JSON
                                Object)*</label>
                            <textarea id="editAchCriteria" rows="4" required class="input-field font-mono text-xs"
                                placeholder='{"type": "complete_topic", "value": "searching"}'></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter a valid JSON object with
                                'type' and 'value'.</p>
                        </div>
                        <div>
                            <label for="editAchIsActive"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <select id="editAchIsActive" class="input-field">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p id="editAchError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button id="closeAchievementModalBtn" type="button"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button id="saveAchChangesBtn" type="button"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="manageUserTopicsModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="userTopicsModalTitle">
                        Manage Topic Access for User</h3>
                    <button id="closeUserTopicsModalBtnTop"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <input type="hidden" id="manageTopicsUserId">
                <div id="userTopicsListContainer" class="px-7 py-3 max-h-[60vh] overflow-y-auto space-y-3">
                    <div class="loading-skeleton h-10 w-full rounded"></div>
                    <div class="loading-skeleton h-10 w-full rounded"></div>
                    <div class="loading-skeleton h-10 w-full rounded"></div>
                </div>
                <p id="manageUserTopicsError" class="text-red-500 text-sm mt-2 px-7 h-4"></p>
                <div class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end">
                    <button id="closeUserTopicsModalBtn" type="button"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="globalAlert"
        class="fixed bottom-5 right-5 z-50 hidden max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0">
        <p id="globalAlertMessage" class="mr-4"></p>
        <button onclick="hideGlobalAlert()" aria-label="Close alert">&times;</button>
    </div>


    <script>
        const API_BASE_URL = '/api';
        let currentUserPage = 1;
        let userSearchTerm = '';

        // --- Add state variables for sorting ---
        let currentUserSortBy = 'createdAt'; // Default sort field
        let currentUserSortOrder = 'asc';    // Default sort order

        // --- UTILITIES ---
        function getAuthToken() { return localStorage.getItem('authToken'); }

        function checkAdminAuth() {
            const token = getAuthToken();
            const userStr = localStorage.getItem('currentUser');
            let userRole = null;
            if (userStr) { try { userRole = JSON.parse(userStr).role; } catch (e) { } }
            if (!token || userRole !== 'admin') {
                console.warn("Not authenticated as admin, redirecting...");
                localStorage.clear();
                window.location.href = 'auth.html';
                return false;
            }
            return true;
        }

        async function makeAdminAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!checkAdminAuth()) return null;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(`${API_BASE_URL}/admin${endpoint}`, {
                    signal: controller.signal,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers },
                    ...options
                });
                clearTimeout(timeoutId);
                let data;
                try {
                    const text = await response.text();
                    data = text ? JSON.parse(text) : { success: response.ok };
                } catch (e) {
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${response.statusText}. Response not JSON.`);
                    return { success: true };
                }
                if (response.status === 401 || response.status === 403) {
                    checkAdminAuth(); return null;
                }
                if (!response.ok) throw new Error(data.message || `HTTP Error ${response.status}`);
                return data;
            } catch (error) {
                const message = error.name === 'AbortError' ? 'Request timed out.' : error.message;
                console.error(`API Error (${endpoint}):`, message, error);
                showGlobalAlert(`Error: ${message}`, 'error');
                return null;
            }
        }

        function showGlobalAlert(message, type = 'info') {
            const alertDiv = document.getElementById('globalAlert');
            const messageP = document.getElementById('globalAlertMessage');
            alertDiv.className = 'fixed bottom-5 right-5 z-50 max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0'; // Reset classes
            messageP.textContent = message;
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            alertDiv.classList.add(colors[type] || colors.info, 'text-white');
            alertDiv.classList.remove('hidden');
            void alertDiv.offsetWidth; // Force reflow
            alertDiv.classList.remove('opacity-0');
            if (alertDiv.alertTimeout) clearTimeout(alertDiv.alertTimeout);
            alertDiv.alertTimeout = setTimeout(hideGlobalAlert, 5000);
        }
        function hideGlobalAlert() {
            const alertDiv = document.getElementById('globalAlert');
            alertDiv.classList.add('opacity-0');
            setTimeout(() => {
                alertDiv.classList.add('hidden');
                if (alertDiv.alertTimeout) { clearTimeout(alertDiv.alertTimeout); alertDiv.alertTimeout = null; }
            }, 300); // Match CSS transition duration
        }

        // --- CORE FUNCTIONS ---


        // --- User Topic Access Management ---

        async function openManageUserTopicsModal(userId, username) {
            const modal = document.getElementById('manageUserTopicsModal');
            const title = document.getElementById('userTopicsModalTitle');
            const listContainer = document.getElementById('userTopicsListContainer');
            const errorP = document.getElementById('manageUserTopicsError');

            title.textContent = `Manage Access for: ${username}`;
            document.getElementById('manageTopicsUserId').value = userId;
            errorP.textContent = '';
            listContainer.innerHTML = `
                <div class="loading-skeleton h-10 w-full rounded mb-2"></div>
                <div class="loading-skeleton h-8 w-full rounded ml-4 mb-1"></div>
                <div class="loading-skeleton h-8 w-full rounded ml-4 mb-2"></div>
                <div class="loading-skeleton h-10 w-full rounded mb-2"></div>
                <div class="loading-skeleton h-8 w-full rounded ml-4 mb-1"></div>`; // Updated skeleton
            modal.classList.add('show');

            // Fetch BOTH topic statuses for the user AND general topic definitions
            try {
                const [statusData, topicsData] = await Promise.all([
                    makeAdminAPICall(`/users/${userId}/topic-statuses`), // Existing call
                    makeAdminAPICall('/topics') // Fetch all topic definitions including algorithms
                ]);

                if (statusData?.success && statusData.topicStatuses && topicsData?.success && topicsData.topics) {
                    // Combine the data: add algorithm definitions to the status data
                    const enrichedStatuses = statusData.topicStatuses.map(status => {
                        const definition = topicsData.topics.find(t => t._id === status._id);
                        return {
                            ...status,
                            algorithms: definition?.algorithms || [] // Add algorithms array
                        };
                    });
                    renderUserTopicsAndAlgorithmsList(enrichedStatuses); // Call the new rendering function
                } else {
                    throw new Error('Failed to load topic statuses or definitions.');
                }
            } catch (error) {
                console.error("Error loading user topic/algorithm access:", error);
                errorP.textContent = error.message || 'Failed to load access details for this user.';
                listContainer.innerHTML = '<p class="text-center text-red-500 dark:text-red-400">Error loading data.</p>';
            }
        }

        function closeManageUserTopicsModal() {
            document.getElementById('manageUserTopicsModal').classList.remove('show');
        }

        // admin_dashboard.html

        // ... (other JS functions)

        function renderUserTopicsAndAlgorithmsList(enrichedTopicStatuses) {
            const listContainer = document.getElementById('userTopicsListContainer');
            const userId = document.getElementById('manageTopicsUserId').value;
            listContainer.innerHTML = ''; // Clear loading state

            if (!enrichedTopicStatuses || enrichedTopicStatuses.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No topics found.</p>';
                return;
            }

            enrichedTopicStatuses.forEach(topic => {
                const isGloballyLockedTopic = topic.isGloballyLocked;
                const effectiveStatusTopic = topic.effectiveStatus;
                const statusTextTopic = topic.statusText;
                let statusColorClassTopic;

                if (effectiveStatusTopic === 'locked') {
                    statusColorClassTopic = 'bg-red-200 text-red-800 dark:bg-red-900 dark:text-red-300';
                } else {
                    statusColorClassTopic = 'bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-300';
                }

                const showUnlockButtonTopic = effectiveStatusTopic === 'locked';
                const topicButtonHtml = showUnlockButtonTopic
                    ? `<button id="toggle-topic-lock-${topic._id}" onclick="toggleUserTopicLock('${userId}', '${topic._id}', '${topic.name}', false)" class="px-3 py-1 rounded text-white text-xs font-semibold bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-50" title="${isGloballyLockedTopic ? 'Unlock topic ONLY for this user (Overrides Global Lock)' : 'Unlock topic for this user'}"><i class="fas fa-unlock-alt mr-1"></i>Unlock Topic</button>`
                    : `<button id="toggle-topic-lock-${topic._id}" onclick="toggleUserTopicLock('${userId}', '${topic._id}', '${topic.name}', true)" class="px-3 py-1 rounded text-white text-xs font-semibold bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 disabled:opacity-50" title="${isGloballyLockedTopic ? 'Lock topic for this user (Removes Override)' : 'Lock topic for this user'}"><i class="fas fa-lock mr-1"></i>Lock Topic</button>`;

                const topicDiv = document.createElement('div');
                topicDiv.className = 'mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border dark:border-gray-600';
                topicDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-800 dark:text-gray-200">${topic.name}</span>
                        <div>
                            <span class="text-sm mr-4 px-2 py-1 rounded ${statusColorClassTopic}">${statusTextTopic}</span>
                            ${topicButtonHtml}
                        </div>
                    </div>
                    <div id="algo-list-${topic._id}" class="pl-4 border-l-2 border-gray-300 dark:border-gray-500 ml-2 space-y-2">
                        <div class="loading-skeleton h-6 w-3/4 rounded"></div> {/* Placeholder */}
                    </div>`;
                listContainer.appendChild(topicDiv);

                // Now, render algorithms for this topic (async potentially needed if fetching algo status)
                // For now, assume status comes from backend or calculate based on user progress (if fetched)
                renderUserAlgorithmsList(userId, topic._id, topic.algorithms, `algo-list-${topic._id}`);
            });
        }

        // NEW function to render algorithms within the user topic modal
        async function renderUserAlgorithmsList(userId, topicMongoId, algorithms, containerId) {
            const algoListContainer = document.getElementById(containerId);
            if (!algoListContainer) return;

            // Fetch user data to determine user-specific algorithm status (if not already available)
            // NOTE: This adds an extra API call per topic, potentially slow.
            // A better approach might be to enhance the `/users/:userId/topic-statuses` endpoint
            // to optionally include detailed algorithm statuses.
            // For now, let's proceed with the simpler approach assuming we need to check user progress.
            let userProgress = null;
            try {
                // Simplified fetch - might need adjustment based on your user data structure
                 const userData = await makeAdminAPICall(`/users/${userId}`); // Re-fetch user data (inefficient)
                 if(userData?.success && userData.user?.progress) {
                     // Need to find the correct topic progress using the topic's *custom ID*, not Mongo ID
                     const topicDefinition = await makeAdminAPICall(`/topics/${topicMongoId}`); // Fetch topic def to get custom ID
                     if(topicDefinition?.success && topicDefinition.topic) {
                         const topicCustomId = topicDefinition.topic.id;
                         userProgress = userData.user.progress[topicCustomId]; // Access progress using custom ID
                     }
                 }
            } catch(e) { console.error("Could not fetch user progress for algorithm status", e); }


            if (!algorithms || algorithms.length === 0) {
                algoListContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400 italic">No algorithms in this topic.</p>';
                return;
            }

            algoListContainer.innerHTML = ''; // Clear placeholder

            algorithms.forEach(algo => {
                const algoId = algo.id; // String ID like 'bubbleSort'
                const isGloballyLockedAlgo = algo.isGloballyLocked === true;

                // --- Determine User-Specific Status ---
                let userAlgoStatus = 'available'; // Default
                 if (userProgress?.algorithms && userProgress.algorithms[algoId]) {
                     userAlgoStatus = userProgress.algorithms[algoId].status || 'available';
                 }
                 // --- End Determine User-Specific Status ---

                 // --- Determine Effective Status (Simplified - ignores topic lock for now, handled visually by parent) ---
                 let effectiveAlgoStatus = 'available';
                 if (isGloballyLockedAlgo) {
                     effectiveAlgoStatus = (userAlgoStatus === 'available') ? 'available' : 'locked';
                 } else {
                     effectiveAlgoStatus = userAlgoStatus;
                 }
                 // --- End Effective Status ---

                let statusColorClassAlgo;
                let statusIconAlgo;
                if (effectiveAlgoStatus === 'locked') {
                    statusColorClassAlgo = 'text-red-500 dark:text-red-400';
                    statusIconAlgo = 'fa-lock';
                } else { // available or completed
                    statusColorClassAlgo = 'text-green-500 dark:text-green-400';
                    statusIconAlgo = 'fa-unlock-alt'; // Or fa-check-circle if completed
                }

                // Determine button action based on *user-specific* status for direct control
                const showUnlockButtonAlgo = userAlgoStatus === 'locked'; // Button action depends on user's direct status
                const algoButtonHtml = showUnlockButtonAlgo
                    ? `<button onclick="toggleUserAlgorithmLock('${userId}', '${topicMongoId}', '${algoId}', '${algo.name}', false)" class="px-2 py-0.5 rounded text-white text-xs font-semibold bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-1 focus:ring-green-300 disabled:opacity-50" title="Unlock algorithm ONLY for this user"><i class="fas fa-unlock-alt text-xs"></i></button>`
                    : `<button onclick="toggleUserAlgorithmLock('${userId}', '${topicMongoId}', '${algoId}', '${algo.name}', true)" class="px-2 py-0.5 rounded text-white text-xs font-semibold bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-1 focus:ring-red-300 disabled:opacity-50" title="Lock algorithm ONLY for this user"><i class="fas fa-lock text-xs"></i></button>`;


                const algoDiv = document.createElement('div');
                algoDiv.className = 'flex justify-between items-center text-sm';
                algoDiv.innerHTML = `
                    <span class="text-gray-700 dark:text-gray-300">
                        <i class="fas ${statusIconAlgo} ${statusColorClassAlgo} mr-2 w-4 text-center" title="Effective Status: ${effectiveAlgoStatus}"></i>
                        ${algo.name}
                        ${isGloballyLockedAlgo ? '<i class="fas fa-globe-americas text-gray-400 dark:text-gray-500 ml-1 text-xs" title="Globally Locked"></i>' : ''}
                    </span>
                    <div id="algo-actions-${topicMongoId}-${algoId}">
                        ${algoButtonHtml}
                    </div>
                `;
                algoListContainer.appendChild(algoDiv);
            });
        }

        // NEW function to toggle lock status for a specific algorithm for a specific user
        async function toggleUserAlgorithmLock(userId, topicMongoId, algoId, algoName, lock) {
            const action = lock ? 'lock' : 'unlock';
            const actionVerb = lock ? 'Locking' : 'Unlocking';
            const buttonContainerId = `algo-actions-${topicMongoId}-${algoId}`;
            const buttonContainer = document.getElementById(buttonContainerId);
            const errorP = document.getElementById('manageUserTopicsError');
            errorP.textContent = ''; // Clear previous errors

            let originalButtonHtml = '';
            if (buttonContainer) {
                originalButtonHtml = buttonContainer.innerHTML; // Store original button
                buttonContainer.innerHTML = `<span class="text-xs text-yellow-600 dark:text-yellow-400"><i class="fas fa-spinner fa-spin mr-1"></i>${actionVerb}...</span>`;
            }

            showGlobalAlert(`${actionVerb} "${algoName}" for user...`, 'info');
            const endpoint = `/topics/${topicMongoId}/algorithms/${algoId}/${action}`;

            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify({ userId: userId }) });

            hideGlobalAlert(); // Hide working message

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                // Refresh just the algorithm list for this topic to show the change
                 const topicElement = document.getElementById(`algo-list-${topicMongoId}`);
                 if (topicElement) {
                     // Need the algorithms array again to re-render
                     // This is inefficient - ideally, the API response would tell us the new state
                     // Or we update the button state directly based on success
                     const topicDefinition = await makeAdminAPICall(`/topics/${topicMongoId}`); // Re-fetch topic def
                     if(topicDefinition?.success && topicDefinition.topic?.algorithms) {
                         renderUserAlgorithmsList(userId, topicMongoId, topicDefinition.topic.algorithms, `algo-list-${topicMongoId}`);
                     } else {
                         if (buttonContainer) buttonContainer.innerHTML = '<span class="text-xs text-red-500">Refresh Error</span>'; // Indicate error
                     }
                 }
            } else {
                const errorMsg = result?.message || `Failed to ${action} algorithm for user.`;
                showGlobalAlert(errorMsg, 'error');
                errorP.textContent = errorMsg; // Show error in modal
                // Restore original button on failure
                if (buttonContainer) {
                    buttonContainer.innerHTML = originalButtonHtml;
                }
            }
        }

        // Ensure toggleUserTopicLock calls the API correctly (it seems okay already)
        async function toggleUserTopicLock(userId, topicMongoId, topicName, lock) { // lock = true to lock, false to unlock
            const action = lock ? 'lock' : 'unlock';
            const buttonId = `toggle-lock-${topicMongoId}`;
            const button = document.getElementById(buttonId);
            const errorP = document.getElementById('manageUserTopicsError');
            errorP.textContent = '';

            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Working...';
            }

            // Use showGlobalAlert for feedback
            showGlobalAlert(`${lock ? 'Locking' : 'Unlocking'} "${topicName}" for user...`, 'info');
            const endpoint = `/topics/${topicMongoId}/${action}`; // Use lock or unlock endpoint

            // Send userId in the body
            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify({ userId: userId }) });

            // Hide the working message immediately after the call finishes
            hideGlobalAlert();

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                // Refresh the list in the modal by re-fetching data
                const username = document.getElementById('userTopicsModalTitle').textContent.replace('Manage Topic Access for: ', ''); // Get username from title
                // Re-call openManageUserTopicsModal to fetch fresh data and re-render
                await openManageUserTopicsModal(userId, username); // Add await here
            } else {
                const errorMsg = result?.message || `Failed to ${action} topic for user.`;
                showGlobalAlert(errorMsg, 'error');
                if (errorP) errorP.textContent = errorMsg; // Show error in modal as well

                // Re-enable button on failure and restore its state
                if (button) {
                    button.disabled = false;
                    // Restore button text based on the intended action (lock or unlock)
                    const iconClass = lock ? 'fa-lock' : 'fa-unlock-alt';
                    const buttonText = lock ? 'Lock for User' : 'Unlock for User';
                    const buttonColorClass = lock ? 'bg-red-500 hover:bg-red-600 focus:ring-red-300' : 'bg-green-500 hover:bg-green-600 focus:ring-green-300';
                    const titleText = lock
                        ? (topic.isGloballyLocked ? 'Lock topic for this user (Removes Override)' : 'Lock topic for this user') // Re-evaluate title based on current global state if needed
                        : (topic.isGloballyLocked ? 'Unlock topic ONLY for this user (Overrides Global Lock)' : 'Unlock topic for this user');

                    button.innerHTML = `<i class="fas ${iconClass} mr-1"></i>${buttonText}`;
                    button.className = `px-3 py-1 rounded text-white text-xs font-semibold focus:outline-none focus:ring-2 disabled:opacity-50 ${buttonColorClass}`;
                    button.title = titleText; // Update title as well
                }
            }
        }


        // Ensure toggleTopicLock calls the API correctly for GLOBAL actions
        async function toggleTopicLock(topicMongoId, topicName, lock) { // lock is true to lock, false to unlock
            const action = lock ? 'lock' : 'unlock';
            if (!confirm(`${lock ? 'Globally lock' : 'Globally unlock'} topic "${topicName}"? This affects ALL users.`)) {
                return;
            }

            showGlobalAlert(`${lock ? 'Locking' : 'Unlocking'} "${topicName}" globally...`, 'info');
            const endpoint = `/topics/${topicMongoId}/${action}`; // Use lock or unlock endpoint

            // Send global: true in the body
            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify({ global: true }) });

            // Hide the working message immediately after the call finishes
            hideGlobalAlert();

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
            } else {
                showGlobalAlert(result?.message || `Failed to ${action} topic globally.`, 'error');
            }
            // Reload topics list after action attempt to reflect changes
            loadTopics();

        }

        // ... (rest of the JS code, including toggleUserTopicLock)

        async function toggleUserTopicLock(userId, topicMongoId, topicName, lock) { // lock = true to lock, false to unlock
            const action = lock ? 'lock' : 'unlock';
            const buttonId = `toggle-lock-${topicMongoId}`;
            const button = document.getElementById(buttonId);
            const errorP = document.getElementById('manageUserTopicsError');
            errorP.textContent = '';

            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Working...';
            }


            showGlobalAlert(`${lock ? 'Locking' : 'Unlocking'} "${topicName}" for user...`, 'info');
            const endpoint = `/topics/${topicMongoId}/${action}`; // Use lock or unlock endpoint

            // Send userId in the body
            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify({ userId: userId }) });

            hideGlobalAlert(); // Hide the working message

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                // Refresh the list in the modal
                const username = document.getElementById('userTopicsModalTitle').textContent.replace('Manage Topic Access for: ', ''); // Get username from title
                openManageUserTopicsModal(userId, username); // Re-fetch and re-render
            } else {
                const errorMsg = result?.message || `Failed to ${action} topic for user.`;
                showGlobalAlert(errorMsg, 'error');
                errorP.textContent = errorMsg;
                // Re-enable button on failure
                if (button) {
                    button.disabled = false;
                    // Restore button text based on the intended action's OPPOSITE (since it failed)
                    button.innerHTML = `
                 ${lock ? '<i class="fas fa-lock mr-1"></i>Lock' : '<i class="fas fa-unlock mr-1"></i>Unlock'}
             `;
                }
            }
        }

        // --- End User Topic Access Management ---

        async function loadStats() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `<div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow loading-skeleton h-24"></div>`.repeat(4);
            const data = await makeAdminAPICall('/stats');
            if (data?.success && data.stats) {
                container.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition hover:shadow-lg hover:-translate-y-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Users</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">${data.stats.totalUsers}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition hover:shadow-lg hover:-translate-y-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Topics</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">${data.stats.activeTopics}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition hover:shadow-lg hover:-translate-y-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Achievements</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">${data.stats.totalAchievements}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition hover:shadow-lg hover:-translate-y-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Leaderboard Entries</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">${data.stats.leaderboardUsers}</p>
                    </div>`;
            } else {
                container.innerHTML = '<p class="text-red-500 dark:text-red-400 col-span-full">Failed to load stats.</p>';
            }
        }

        // --- User Management ---
        async function loadUsers(page = 1, search = '', sortBy = currentUserSortBy, sortOrder = currentUserSortOrder) {
            currentUserPage = page;
            userSearchTerm = search;
            currentUserSortBy = sortBy; // Update global sort state
            currentUserSortOrder = sortOrder;

            const tbody = document.getElementById('usersTableBody');
            // Adjust colspan for new columns (now 8 columns total)
            tbody.innerHTML = '<tr><td colspan="8" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>'.repeat(5);
            renderUserPagination(0, 0, 0, true); // Pass loading state

            // Add sort parameters to API call
            const endpoint = `/users?page=${page}&limit=10&search=${encodeURIComponent(search)}&sortBy=${sortBy}&sortOrder=${sortOrder}`;
            const data = await makeAdminAPICall(endpoint);

            tbody.innerHTML = ''; // Clear loading skeletons

            // --- Update Sort Icons in Header ---
            updateSortIcons();

            if (data?.success && data.users) {
                if (data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No users found.</td></tr>';
                    renderUserPagination(0, 0, 0); // Render empty state pagination
                    return;
                }
                data.users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";

                    // --- Safely access rank and points ---
                    const rankLevel = user.stats?.rank?.level ?? 'N/A';
                    const rankPoints = user.stats?.rank?.points ?? 0;
                    // --- End safe access ---

                    // --- Update innerHTML to include Rank and Points ---
                    tr.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Username">${user.username}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Email">${user.email}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Rank">${rankLevel}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300 text-right" data-label="Points">${rankPoints}</td> 
                <td class="px-6 py-4 text-sm" data-label="Role"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'}">${user.role}</span></td>
                <td class="px-6 py-4 text-sm" data-label="Verified"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${user.isEmailVerified ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}">${user.isEmailVerified ? 'Yes' : 'No'}</span></td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Joined">${new Date(user.createdAt).toLocaleDateString()}</td>
                <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                    <button onclick="openManageUserTopicsModal('${user._id}', '${user.username}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-3 focus:outline-none focus:ring-2 focus:ring-blue-300 rounded" title="Manage User Topic Access"><i class="fas fa-list-check"></i></button>
                    <button onclick="openEditUserModal('${user._id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3 focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded" title="Edit User"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteUser('${user._id}', '${user.username}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-300 rounded" title="Delete User"><i class="fas fa-trash"></i></button>
                </td>`;
                    // --- End innerHTML Update ---
                    tbody.appendChild(tr);
                });
                renderUserPagination(data.totalUsers, data.currentPage, data.totalPages);
            } else {
                // Adjust colspan for error message
                tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load users.</td></tr>';
                renderUserPagination(0, 0, 0); // Render empty state
            }
        }
        function renderUserPagination(totalUsers, currentPage, totalPages, isLoading = false) {
            const paginationDiv = document.getElementById('userPagination');
            const totalInfoSpan = paginationDiv.querySelector('span');
            const buttonsContainer = paginationDiv.querySelector('div');
            buttonsContainer.innerHTML = '';
            if (isLoading) { totalInfoSpan.textContent = 'Loading users...'; return; }
            totalInfoSpan.textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages} (Total: ${totalUsers} users)` : `Total Users: ${totalUsers}`;
            if (totalPages <= 1) return;
            let buttonsHtml = '';
            // --- Pass sort parameters to loadUsers in pagination buttons ---
            const createButton = (page, text, disabled = false) => `<button onclick="loadUsers(${page}, userSearchTerm, currentUserSortBy, currentUserSortOrder)" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded text-sm mx-1 hover:bg-blue-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed" ${disabled ? 'disabled' : ''}>${text}</button>`;
            // --- End modification ---
            const createCurrentButton = (page) => `<button class="bg-blue-500 text-white px-3 py-1 rounded text-sm mx-1 focus:outline-none focus:ring-2 focus:ring-blue-300" disabled aria-current="page">${page}</button>`;
            const createEllipsis = () => `<span class="px-2 py-1 text-gray-500 dark:text-gray-400">...</span>`;
            buttonsHtml += createButton(currentPage - 1, '&laquo; Prev', currentPage === 1);
            const maxVisibleButtons = 5, sideButtons = Math.floor((maxVisibleButtons - 3) / 2);
            if (totalPages <= maxVisibleButtons) { for (let i = 1; i <= totalPages; i++) buttonsHtml += (i === currentPage) ? createCurrentButton(i) : createButton(i, i); }
            else {
                buttonsHtml += (1 === currentPage) ? createCurrentButton(1) : createButton(1, 1);
                if (currentPage > sideButtons + 2) buttonsHtml += createEllipsis();
                let startPage = Math.max(2, currentPage - sideButtons), endPage = Math.min(totalPages - 1, currentPage + sideButtons);
                if (currentPage + sideButtons >= totalPages - 1) startPage = Math.max(2, totalPages - maxVisibleButtons + 2);
                if (currentPage - sideButtons <= 2) endPage = Math.min(totalPages - 1, maxVisibleButtons - 1);
                for (let i = startPage; i <= endPage; i++) buttonsHtml += (i === currentPage) ? createCurrentButton(i) : createButton(i, i);
                if (currentPage < totalPages - sideButtons - 1) buttonsHtml += createEllipsis();
                buttonsHtml += (totalPages === currentPage) ? createCurrentButton(totalPages) : createButton(totalPages, totalPages);
            }
            buttonsHtml += createButton(currentPage + 1, 'Next &raquo;', currentPage === totalPages);
            buttonsContainer.innerHTML = buttonsHtml;
        }

        // --- NEW Function to handle sort column clicks ---
        function handleSortClick(event) {
            const header = event.target.closest('th[data-sort]'); // Find the parent TH with data-sort
            if (!header) return;

            const sortBy = header.dataset.sort;

            // Determine new sort order
            let newSortOrder = 'asc';
            if (sortBy === currentUserSortBy) {
                // If clicking the same column, toggle the order
                newSortOrder = currentUserSortOrder === 'asc' ? 'desc' : 'asc';
            }
            // else { // Clicking a new column, default to 'asc' }

            loadUsers(1, userSearchTerm, sortBy, newSortOrder); // Load page 1 with new sort
        }

        // --- NEW Function to update sort icons in table header ---
        function updateSortIcons() {
            document.querySelectorAll('#users thead th[data-sort]').forEach(th => {
                const sortKey = th.dataset.sort;
                const icon = th.querySelector('i.fas');
                if (icon) {
                    if (sortKey === currentUserSortBy) {
                        icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down', 'opacity-50');
                        icon.classList.add(currentUserSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                        icon.classList.remove('opacity-50'); // Make active icon fully visible
                    } else {
                        icon.classList.remove('fa-sort-up', 'fa-sort-down');
                        icon.classList.add('fa-sort', 'opacity-50'); // Reset to default sort icon
                    }
                }
            });
        }
        // --- NEW Topic Lock Functionality ---
        async function toggleTopicLock(topicMongoId, topicName, lock) { // lock is true to lock, false to unlock
            const action = lock ? 'lock' : 'unlock';
            if (!confirm(`${lock ? 'Globally lock' : 'Globally unlock'} topic "${topicName}"? This affects ALL users.`)) {
                return;
            }

            showGlobalAlert(`${lock ? 'Locking' : 'Unlocking'} "${topicName}" globally...`, 'info');
            const endpoint = `/topics/${topicMongoId}/${action}`; // Use lock or unlock endpoint
            // Send global: true in the body
            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify({ global: true }) });

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
            } else {
                showGlobalAlert(`Failed to ${action} topic globally.`, 'error');
            }
            // Reload topics list after action attempt
            loadTopics();
        }
        // --- END NEW Topic Lock Functionality ---
        async function openEditUserModal(userId) {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            form.reset(); document.getElementById('editUserError').textContent = ''; document.getElementById('saveUserChangesBtn').disabled = true;
            showGlobalAlert('Loading user data...', 'info');
            const data = await makeAdminAPICall(`/users/${userId}`);
            hideGlobalAlert();
            if (data?.success && data.user) {
                const user = data.user;
                document.getElementById('modalTitle').textContent = `Edit User: ${user.username}`; document.getElementById('editUserId').value = user._id;
                document.getElementById('editUserRole').value = user.role; document.querySelector(`input[name="isEmailVerified"][value="${user.isEmailVerified}"]`).checked = true;
                document.getElementById('saveUserChangesBtn').disabled = false; modal.classList.add('show');
            }
        }
        function closeEditUserModal() { document.getElementById('editUserModal').classList.remove('show'); }
        // --- Modify saveUserChanges to preserve sort order ---
        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value, role = document.getElementById('editUserRole').value, isEmailVerified = document.querySelector('input[name="isEmailVerified"]:checked').value === 'true';
            const errorP = document.getElementById('editUserError'), saveButton = document.getElementById('saveUserChangesBtn');
            errorP.textContent = ''; saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            const result = await makeAdminAPICall(`/users/${userId}`, { method: 'PUT', body: JSON.stringify({ role, isEmailVerified }) });
            saveButton.disabled = false; saveButton.innerHTML = 'Save Changes';
            if (result?.success) {
                showGlobalAlert('User updated!', 'success');
                closeEditUserModal();
                // Pass current sort order when reloading
                loadUsers(currentUserPage, userSearchTerm, currentUserSortBy, currentUserSortOrder);
            }
            else { errorP.textContent = result?.message || 'Update failed.'; }
        }
        async function deleteUser(userId, username) {
            if (confirm(`DELETE user "${username}"?\nThis CANNOT be undone.`)) {
                showGlobalAlert('Deleting user...', 'info');
                const result = await makeAdminAPICall(`/users/${userId}`, { method: 'DELETE' });
                if (result?.success) {
                    showGlobalAlert(`User "${username}" deleted!`, 'success');
                    const tbody = document.getElementById('usersTableBody');
                    const isLastOnPage = tbody.childElementCount === 1;
                    const pageToLoad = isLastOnPage && currentUserPage > 1 ? currentUserPage - 1 : currentUserPage;
                    // Pass current sort order when reloading
                    loadUsers(pageToLoad, userSearchTerm, currentUserSortBy, currentUserSortOrder);
                }
            }
        }

        // --- Topic Management ---
        async function loadTopics() {
            const tbody = document.getElementById('topicsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>'.repeat(3);
            const data = await makeAdminAPICall('/topics');
            tbody.innerHTML = '';
            if (data?.success && data.topics) {
                if (data.topics.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No topics found.</td></tr>'; return; }
                data.topics.forEach(topic => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    tr.innerHTML = `
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Order">${topic.order}</td>
            <td class="px-6 py-4 text-sm font-mono text-gray-700 dark:text-gray-200" data-label="ID">${topic.id}</td>
            <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Name">${topic.name}</td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Difficulty">${topic.difficulty}</td>
            <td class="px-6 py-4 text-sm" data-label="Status">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${topic.isActive ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300'}">${topic.isActive ? 'Active' : 'Inactive'}</span>
                ${topic.isGloballyLocked ? '<span class="ml-2 px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"><i class="fas fa-lock mr-1"></i>Global Lock</span>' : ''}
            </td>
            <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                <button onclick="openEditTopicModal('${topic._id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded" title="Edit Topic"><i class="fas fa-edit"></i></button>
                <button onclick="deleteTopic('${topic._id}', '${topic.name}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 mr-2 focus:outline-none focus:ring-2 focus:ring-red-300 rounded" title="Delete Topic"><i class="fas fa-trash"></i></button>
                ${topic.isGloballyLocked
                            ? `<button onclick="toggleTopicLock('${topic._id}', '${topic.name}', false)" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 focus:outline-none focus:ring-2 focus:ring-green-300 rounded" title="Unlock Globally"><i class="fas fa-unlock"></i></button>`
                            : `<button onclick="toggleTopicLock('${topic._id}', '${topic.name}', true)" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-300 rounded" title="Lock Globally / User"><i class="fas fa-lock"></i></button>`
                        }
            </td>`;
                    tbody.appendChild(tr);
                });
            } else { tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load topics.</td></tr>'; }
        }

        // --- MODIFIED Topic Management ---
        let currentTopicAlgorithms = []; // Temporary storage for algorithms while editing a topic

        async function openEditTopicModal(topicId = null) {
            const modal = document.getElementById('editTopicModal'), form = document.getElementById('editTopicForm'), errorP = document.getElementById('editTopicError'), title = document.getElementById('topicModalTitle'), idInput = document.getElementById('editTopicIdInput'), saveButton = document.getElementById('saveTopicChangesBtn');
            errorP.textContent = ''; form.reset(); currentTopicAlgorithms = []; // Reset temp algo storage
            document.getElementById('editTopicId').value = topicId || ''; // Store MongoDB _id here
            const algoListDiv = document.getElementById('topicAlgorithmsList');
            if (algoListDiv) {
                algoListDiv.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-sm italic">Loading algorithms...</p>'; // Reset list
            } else {
                console.error("Algorithm list container not found!");
            }

            if (topicId) { // Editing existing topic
                title.textContent = 'Edit Topic';
                idInput.readOnly = true; // Don't allow changing custom ID
                idInput.classList.add('bg-gray-100', 'dark:bg-gray-600');
                saveButton.disabled = true;
                showGlobalAlert('Loading topic data...', 'info');

                const data = await makeAdminAPICall(`/topics/${topicId}`); // Fetch by MongoDB _id
                hideGlobalAlert();
                saveButton.disabled = false;

                if (data?.success && data.topic) {
                    const t = data.topic;
                    idInput.value = t.id; // Display custom ID
                    document.getElementById('editTopicName').value = t.name;
                    document.getElementById('editTopicOrder').value = t.order;
                    document.getElementById('editTopicEstTime').value = t.estimatedTime;
                    document.getElementById('editTopicIcon').value = t.icon || '';
                    document.getElementById('editTopicColor').value = t.color || '';
                    document.getElementById('editTopicDifficulty').value = t.difficulty;
                    document.getElementById('editTopicIsActive').value = String(t.isActive ?? true);
                    document.getElementById('editTopicDesc').value = t.description || '';

                    // Load algorithms into temporary storage and render list
                    // Use t.algorithms directly (assuming backend sends it as array now)
                    currentTopicAlgorithms = data.topic.algorithms || [];
                    renderTopicAlgorithmsList();
                } else {
                    showGlobalAlert('Could not load topic data.', 'error');
                    closeEditTopicModal();
                    return;
                }
            } else { // Adding new topic
                title.textContent = 'Add New Topic';
                idInput.readOnly = false; // Allow setting custom ID
                idInput.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                document.getElementById('editTopicIsActive').value = 'true';
                document.getElementById('editTopicDifficulty').value = ''; // Reset select
                currentTopicAlgorithms = []; // Start with empty array
                renderTopicAlgorithmsList(); // Show "No algorithms" message
                saveButton.disabled = false;
            }
            modal.classList.add('show');
        }

        function closeEditTopicModal() {
            document.getElementById('editTopicModal').classList.remove('show');
            currentTopicAlgorithms = []; // Clear temp storage on close
        }

        async function saveTopicChanges() {
            const topicMongoId = document.getElementById('editTopicId').value; // MongoDB _id or empty
            const errorP = document.getElementById('editTopicError');
            const saveButton = document.getElementById('saveTopicChangesBtn');
            errorP.textContent = ''; saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            // Validate base topic data first
            const topicCustomId = document.getElementById('editTopicIdInput').value.trim();
            const topicName = document.getElementById('editTopicName').value.trim();
            const topicOrder = document.getElementById('editTopicOrder').value;
            const topicEstTime = document.getElementById('editTopicEstTime').value;
            const topicDifficulty = document.getElementById('editTopicDifficulty').value;

            if (!topicCustomId || !topicName || topicOrder === '' || topicEstTime === '' || !topicDifficulty) {
                errorP.textContent = 'Please fill all required topic fields (*).';
                saveButton.disabled = false; saveButton.innerHTML = 'Save Changes';
                return;
            }

            const topicData = {
                id: topicCustomId, // Custom String ID for new topics
                name: topicName,
                order: parseInt(topicOrder),
                estimatedTime: parseInt(topicEstTime),
                difficulty: topicDifficulty,
                icon: document.getElementById('editTopicIcon').value.trim() || undefined,
                color: document.getElementById('editTopicColor').value.trim() || undefined,
                isActive: document.getElementById('editTopicIsActive').value === 'true',
                description: document.getElementById('editTopicDesc').value.trim() || undefined,
                // Send the algorithms array directly from our temporary storage
                algorithms: currentTopicAlgorithms // Send as array
            };

            // Don't send the custom string 'id' when updating (backend uses MongoDB _id)
            if (topicMongoId) delete topicData.id;

            const method = topicMongoId ? 'PUT' : 'POST';
            const endpoint = topicMongoId ? `/topics/${topicMongoId}` : '/topics'; // Use MongoDB _id for PUT

            const result = await makeAdminAPICall(endpoint, { method, body: JSON.stringify(topicData) });
            saveButton.disabled = false; saveButton.innerHTML = 'Save Changes';
            if (result?.success) {
                showGlobalAlert(`Topic ${topicMongoId ? 'updated' : 'created'}!`, 'success');
                closeEditTopicModal();
                loadTopics(); // Refresh the main topics list
            } else {
                errorP.textContent = result?.message || `Failed to ${topicMongoId ? 'update' : 'create'}.`;
            }
        }

        async function deleteTopic(topicId, topicName) {
            if (confirm(`DELETE topic "${topicName}"?\nThis also removes its algorithms.`)) {
                showGlobalAlert('Deleting topic...', 'info'); const result = await makeAdminAPICall(`/topics/${topicId}`, { method: 'DELETE' });
                if (result?.success) { showGlobalAlert(`Topic "${topicName}" deleted!`, 'success'); loadTopics(); }
            }
        }

        // --- NEW Algorithm Management Functions ---
        function renderTopicAlgorithmsList() {
            const listDiv = document.getElementById('topicAlgorithmsList');
            const topicMongoId = document.getElementById('editTopicId').value; // Get topic's Mongo ID

            if (!listDiv) return;
            listDiv.innerHTML = '';
            if (currentTopicAlgorithms.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-sm italic">No algorithms added yet.</p>';
                return;
            }

            currentTopicAlgorithms.forEach((algo, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white dark:bg-gray-800 p-2 rounded border dark:border-gray-500 text-sm space-x-2'; // Added space-x-2

                // --- NEW: Lock Status Indicator ---
                let lockIndicator = '';
                if (algo.isGloballyLocked) {
                    lockIndicator = `<span class="ml-1 px-1 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300" title="Globally Locked"><i class="fas fa-lock"></i></span>`;
                }
                // User-specific lock status isn't directly available here, maybe fetch later if needed for display.

                // --- NEW: Lock/Unlock Buttons ---
                const algoId = algo.id; // The string ID like 'bubbleSort'
                const lockButtonHtml = algo.isGloballyLocked
                    ? `<button type="button" onclick="toggleAlgorithmLock('${topicMongoId}', '${algoId}', '${algo.name}', false, true)" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 focus:outline-none text-xs" title="Unlock Globally"><i class="fas fa-unlock"></i></button>`
                    : `<button type="button" onclick="toggleAlgorithmLock('${topicMongoId}', '${algoId}', '${algo.name}', true, true)" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 focus:outline-none text-xs" title="Lock Globally"><i class="fas fa-lock"></i></button>`;

                // Add user-specific lock/unlock if needed (would require knowing current user context or another API call)
                // For simplicity, we'll focus on global lock/unlock in the topic modal first.

                itemDiv.innerHTML = `
            <span class="flex-grow">
                <strong class="font-mono text-blue-600 dark:text-blue-400">${algo.id}</strong> - ${algo.name} (${algo.difficulty})
                ${lockIndicator}
            </span>
            <div class="flex items-center space-x-2 flex-shrink-0">
                 <button type="button" onclick="openEditAlgorithmModal(${index})" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 focus:outline-none" title="Edit Algorithm"><i class="fas fa-edit"></i></button>
                 <button type="button" onclick="deleteAlgorithm(${index})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 focus:outline-none" title="Delete Algorithm"><i class="fas fa-trash"></i></button>
                 ${lockButtonHtml}
                 
                 
             </div>
         `;
                listDiv.appendChild(itemDiv);
            });
        }

        // --- NEW: Function to Toggle Algorithm Lock ---
        async function toggleAlgorithmLock(topicMongoId, algoId, algoName, lock, isGlobal, userId = null) {
            const action = lock ? 'lock' : 'unlock';
            const scope = isGlobal ? 'globally' : `for user ${userId || '?'}`; // Adjust message based on scope

            // Confirmation (optional but recommended for global)
            if (isGlobal && !confirm(`${lock ? 'Globally lock' : 'Globally unlock'} algorithm "${algoName}" within this topic?`)) {
                return;
            }

            showGlobalAlert(`${lock ? 'Locking' : 'Unlocking'} "${algoName}" ${scope}...`, 'info');

            const endpoint = `/topics/${topicMongoId}/algorithms/${algoId}/${action}`;
            const bodyPayload = isGlobal ? { global: true } : { userId: userId }; // Need userId for user-specific

            // Error: Need to actually pass userId for user-specific actions later.
            // For now, this function primarily handles the global toggle via the buttons added.
            if (!isGlobal && !userId) {
                hideGlobalAlert();
                showGlobalAlert('User ID is required for user-specific lock/unlock.', 'error');
                console.error("User ID missing for user-specific algorithm lock toggle.");
                return;
            }

            const result = await makeAdminAPICall(endpoint, { method: 'POST', body: JSON.stringify(bodyPayload) });

            hideGlobalAlert(); // Hide working message

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                // Refresh the topic data in the modal to show the updated lock status
                // Find the algorithm in currentTopicAlgorithms and update its isGloballyLocked status
                const algoIndex = currentTopicAlgorithms.findIndex(a => a.id === algoId);
                if (algoIndex !== -1 && isGlobal) {
                    currentTopicAlgorithms[algoIndex].isGloballyLocked = lock;
                    renderTopicAlgorithmsList(); // Re-render the list inside the modal
                } else if (!isGlobal) {
                    // TODO: Need a way to refresh user-specific status if displayed
                    console.log("User-specific lock/unlock successful, but UI refresh might be needed separately.");
                }

            } else {
                showGlobalAlert(result?.message || `Failed to ${action} algorithm ${scope}.`, 'error');
            }
            // No need to reload the main topics list here, just the modal content
        }

        function openEditAlgorithmModal(index = null) {
            const modal = document.getElementById('editAlgorithmModal');
            const form = document.getElementById('editAlgorithmForm');
            const title = document.getElementById('algorithmModalTitle');
            const errorP = document.getElementById('editAlgoError');
            const algoIdInput = document.getElementById('editAlgoIdInput');
            errorP.textContent = '';
            form.reset();
            document.getElementById('editAlgorithmIndex').value = index !== null ? String(index) : ''; // Store index as string or empty

            if (index !== null && currentTopicAlgorithms[index]) {
                // Editing existing algorithm
                title.textContent = 'Edit Algorithm';
                const algo = currentTopicAlgorithms[index];
                algoIdInput.value = algo.id;
                algoIdInput.readOnly = true; // Don't allow changing ID when editing
                algoIdInput.classList.add('bg-gray-100', 'dark:bg-gray-600');
                document.getElementById('editAlgoName').value = algo.name;
                document.getElementById('editAlgoDifficulty').value = algo.difficulty;
                document.getElementById('editAlgoPoints').value = algo.points;
                document.getElementById('editAlgoDesc').value = algo.description || '';
                document.getElementById('editAlgoTimeComplexity').value = algo.timeComplexity || '';
                document.getElementById('editAlgoSpaceComplexity').value = algo.spaceComplexity || '';
            } else {
                // Adding new algorithm
                title.textContent = 'Add Algorithm';
                algoIdInput.readOnly = false; // Allow setting ID
                algoIdInput.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                document.getElementById('editAlgoDifficulty').value = ''; // Reset select
            }
            modal.classList.add('show');
        }

        function closeEditAlgorithmModal() {
            document.getElementById('editAlgorithmModal').classList.remove('show');
        }

        function saveAlgorithmChanges() {
            const indexStr = document.getElementById('editAlgorithmIndex').value;
            const index = indexStr === '' ? null : parseInt(indexStr);
            const errorP = document.getElementById('editAlgoError');
            const saveButton = document.getElementById('saveAlgorithmChangesBtn');
            errorP.textContent = '';
            saveButton.disabled = true;

            // Collect data from form
            const algoData = {
                id: document.getElementById('editAlgoIdInput').value.trim(),
                name: document.getElementById('editAlgoName').value.trim(),
                difficulty: document.getElementById('editAlgoDifficulty').value,
                points: parseInt(document.getElementById('editAlgoPoints').value),
                description: document.getElementById('editAlgoDesc').value.trim() || undefined,
                timeComplexity: document.getElementById('editAlgoTimeComplexity').value.trim() || undefined,
                spaceComplexity: document.getElementById('editAlgoSpaceComplexity').value.trim() || undefined,
                isGloballyLocked: index !== null ? currentTopicAlgorithms[index].isGloballyLocked : false
            };

            // Basic Validation
            if (!algoData.id || !algoData.name || !algoData.difficulty || isNaN(algoData.points)) {
                errorP.textContent = 'Please fill all required algorithm fields (*).';
                saveButton.disabled = false;
                return;
            }
            // Check for duplicate algorithm ID when adding
            if (index === null && currentTopicAlgorithms.some(a => a.id === algoData.id)) {
                errorP.textContent = `Algorithm ID '${algoData.id}' already exists in this topic.`;
                saveButton.disabled = false;
                return;
            }

            // Update or add to the temporary array
            if (index !== null) {
                algoData.isGloballyLocked = currentTopicAlgorithms[index].isGloballyLocked;
                // Editing
                currentTopicAlgorithms[index] = algoData;
            } else {
                // Adding
                currentTopicAlgorithms.push(algoData);
            }

            // Re-render the list in the topic modal
            renderTopicAlgorithmsList();

            // Close the algorithm modal and re-enable button
            closeEditAlgorithmModal();
            saveButton.disabled = false;
        }

        function deleteAlgorithm(index) {
            if (index >= 0 && index < currentTopicAlgorithms.length) {
                const algoNameToDelete = currentTopicAlgorithms[index].name;
                if (confirm(`Are you sure you want to delete the algorithm "${algoNameToDelete}" from this topic?\n(This won't delete the topic itself)`)) {
                    currentTopicAlgorithms.splice(index, 1); // Remove from temporary array
                    renderTopicAlgorithmsList(); // Update the list in the topic modal
                }
            }
        }
        // --- END NEW Algorithm Management Functions ---

        // --- Achievement Management ---
        async function loadAchievements() {
            const tbody = document.getElementById('achievementsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>'.repeat(4);
            const data = await makeAdminAPICall('/achievements'); tbody.innerHTML = '';
            if (data?.success && data.achievements) {
                if (data.achievements.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No achievements found.</td></tr>'; return; }
                data.achievements.forEach(ach => {
                    const tr = document.createElement('tr'); tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-mono text-gray-700 dark:text-gray-200" data-label="ID">${ach.id}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Name">${ach.name}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Category">${ach.category}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Points">${ach.points}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Rarity">${ach.rarity || 'common'}</td>
                        <td class="px-6 py-4 text-sm" data-label="Active"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${ach.isActive ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300'}">${ach.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick="openEditAchievementModal('${ach._id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3 focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded" title="Edit Achievement"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteAchievement('${ach._id}', '${ach.name}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-300 rounded" title="Delete Achievement"><i class="fas fa-trash"></i></button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            } else { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load achievements.</td></tr>'; }
        }
        async function openEditAchievementModal(achievementId = null) {
            const modal = document.getElementById('editAchievementModal'), form = document.getElementById('editAchievementForm'), errorP = document.getElementById('editAchError'), title = document.getElementById('achievementModalTitle'), idInput = document.getElementById('editAchIdInput'), saveButton = document.getElementById('saveAchChangesBtn');
            errorP.textContent = ''; form.reset(); document.getElementById('editAchievementId').value = achievementId || '';
            if (achievementId) {
                title.textContent = 'Edit Achievement'; idInput.readOnly = true; idInput.classList.add('bg-gray-100', 'dark:bg-gray-600'); saveButton.disabled = true; showGlobalAlert('Loading achievement data...', 'info');
                const data = await makeAdminAPICall(`/achievements/${achievementId}`); hideGlobalAlert(); saveButton.disabled = false;
                if (data?.success && data.achievement) {
                    const ach = data.achievement; idInput.value = ach.id; document.getElementById('editAchName').value = ach.name; document.getElementById('editAchDesc').value = ach.description; document.getElementById('editAchIcon').value = ach.icon;
                    document.getElementById('editAchCategory').value = ach.category; document.getElementById('editAchPoints').value = ach.points; document.getElementById('editAchRarity').value = ach.rarity || 'common'; document.getElementById('editAchIsActive').value = String(ach.isActive ?? true);
                    document.getElementById('editAchCriteria').value = ach.criteriaJson || '{}';
                } else { showGlobalAlert('Could not load achievement data.', 'error'); closeEditAchievementModal(); return; }
            } else {
                title.textContent = 'Add New Achievement'; idInput.readOnly = false; idInput.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                document.getElementById('editAchCriteria').value = '{\n  "type": "example",\n  "value": null\n}'; document.getElementById('editAchIsActive').value = 'true'; document.getElementById('editAchRarity').value = 'common'; document.getElementById('editAchCategory').value = ''; // Reset select
                saveButton.disabled = false;
            }
            modal.classList.add('show');
        }
        function closeEditAchievementModal() { document.getElementById('editAchievementModal').classList.remove('show'); }
        async function saveAchievementChanges() {
            const achievementId = document.getElementById('editAchievementId').value; const errorP = document.getElementById('editAchError'); const saveButton = document.getElementById('saveAchChangesBtn');
            errorP.textContent = ''; saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            const achievementData = {
                id: document.getElementById('editAchIdInput').value.trim(), name: document.getElementById('editAchName').value.trim(), description: document.getElementById('editAchDesc').value.trim(), icon: document.getElementById('editAchIcon').value.trim(),
                category: document.getElementById('editAchCategory').value, points: parseInt(document.getElementById('editAchPoints').value), rarity: document.getElementById('editAchRarity').value, isActive: document.getElementById('editAchIsActive').value === 'true',
                criteriaJson: document.getElementById('editAchCriteria').value.trim()
            };
            try {
                const criteria = JSON.parse(achievementData.criteriaJson || '{}'); if (typeof criteria !== 'object' || criteria === null || !criteria.type || criteria.value === undefined) throw new Error("Criteria JSON must be an object with 'type' and 'value'.");
            } catch (e) { errorP.textContent = `Invalid Criteria JSON: ${e.message}`; saveButton.disabled = false; saveButton.innerHTML = 'Save Changes'; return; }
            if (achievementId) delete achievementData.id; // Don't send string ID on update
            const method = achievementId ? 'PUT' : 'POST'; const endpoint = achievementId ? `/achievements/${achievementId}` : '/achievements';
            const result = await makeAdminAPICall(endpoint, { method, body: JSON.stringify(achievementData) });
            saveButton.disabled = false; saveButton.innerHTML = 'Save Changes';
            if (result?.success) { showGlobalAlert(`Achievement ${achievementId ? 'updated' : 'created'}!`, 'success'); closeEditAchievementModal(); loadAchievements(); }
            else { errorP.textContent = result?.message || `Failed to ${achievementId ? 'update' : 'create'}.`; }
        }
        async function deleteAchievement(achievementId, achievementName) {
            if (confirm(`DELETE achievement "${achievementName}"?`)) {
                showGlobalAlert('Deleting achievement...', 'info'); const result = await makeAdminAPICall(`/achievements/${achievementId}`, { method: 'DELETE' });
                if (result?.success) { showGlobalAlert(`Achievement "${achievementName}" deleted!`, 'success'); loadAchievements(); }
            }
        }

        // --- Settings Actions ---
        async function regenerateLeaderboard() {
            if (!confirm("Regenerate 'all-time' leaderboard? This recalculates ranks.")) return;
            const statusP = document.getElementById('settingsStatus'), button = document.getElementById('regenerateLeaderboardBtn');
            button.disabled = true; statusP.textContent = 'Regenerating...'; statusP.className = 'mt-2 text-sm text-yellow-600 dark:text-yellow-400';
            const result = await makeAdminAPICall('/leaderboard/regenerate', { method: 'POST', body: JSON.stringify({ type: 'all-time' }) });
            button.disabled = false;
            if (result?.success) { statusP.textContent = result.message; statusP.className = 'mt-2 text-sm text-green-600 dark:text-green-400'; showGlobalAlert(result.message, 'success'); }
            else { const errorMsg = result?.message || 'Failed.'; statusP.textContent = `Error: ${errorMsg}`; statusP.className = 'mt-2 text-sm text-red-500 dark:text-red-400'; }
        }

        // --- Navigation & Initialization ---
        function adminLogout() { if (confirm('Logout?')) { localStorage.clear(); window.location.href = 'auth.html'; } }

        function handleNavigation() {
            const hash = window.location.hash || '#overview';
            const targetSectionId = hash.substring(1);
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
            const targetSection = document.getElementById(targetSectionId) || document.getElementById('overview');
            targetSection.classList.remove('hidden');
            const sectionIdToShow = targetSection.id;

            // --- Modify loadIfEmpty for users to use current sort state ---
            const loadIfEmpty = (id, loaderFn, tableBodyId) => {
                if (sectionIdToShow === id) {
                    const body = document.getElementById(tableBodyId);
                    if (!body || !body.hasChildNodes() || (body.children.length === 1 && body.querySelector('[data-label="Loading"]'))) {
                        if (id === 'users') {
                            // Pass current sort state when loading users section
                            loaderFn(1, '', currentUserSortBy, currentUserSortOrder); // Load page 1, empty search, current sort
                        } else {
                            loaderFn(); // For other sections like topics/achievements
                        }
                    }
                }
            };
            // --- End modification ---

            loadIfEmpty('users', loadUsers, 'usersTableBody');
            loadIfEmpty('topics', loadTopics, 'topicsTableBody');
            loadIfEmpty('achievements', loadAchievements, 'achievementsTableBody');

            if (sectionIdToShow === 'overview' && document.getElementById('statsContainer').querySelector('.loading-skeleton')) {
                loadStats();
            }

            document.querySelectorAll('.nav-link').forEach(link => { link.classList.remove('active'); if (link.getAttribute('href') === `#${sectionIdToShow}`) link.classList.add('active'); });
            closeMobileMenu();
        }
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar'), overlay = document.getElementById('overlay'), isOpen = sidebar.classList.contains('translate-x-0');
            sidebar.classList.toggle('-translate-x-full', isOpen); sidebar.classList.toggle('translate-x-0', !isOpen); overlay.classList.toggle('hidden', isOpen);
        }
        function closeMobileMenu() { document.querySelector('.sidebar').classList.add('-translate-x-full'); document.querySelector('.sidebar').classList.remove('translate-x-0'); document.getElementById('overlay').classList.add('hidden'); }

        // Re-check auth on pageshow (handles browser back button from cache)
            window.addEventListener('pageshow', function(event) {
                // event.persisted is true if page is from back/forward cache
                if (!checkAdminAuth()) {
                    console.error("ADMIN PAGE: Auth check FAILED on pageshow. Halting script.");
                }
            });
        
        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("ADMIN PAGE: Checking auth status...");
            if (!checkAdminAuth()) {
                console.error("ADMIN PAGE: Auth check FAILED. Halting script.");
                return;
            }
            console.log("ADMIN PAGE: Auth check PASSED.");

            // --- Setup Event Listeners ---
            console.log("ADMIN PAGE: Setting up event listeners and navigation...");
            document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', closeMobileMenu);
            document.getElementById('regenerateLeaderboardBtn').addEventListener('click', regenerateLeaderboard);

            // User Modal Listeners
            document.getElementById('closeUserModalBtnTop').addEventListener('click', closeEditUserModal);
            document.getElementById('closeUserModalBtn').addEventListener('click', closeEditUserModal);
            document.getElementById('saveUserChangesBtn').addEventListener('click', saveUserChanges);
            const editUserModalElement = document.getElementById('editUserModal');
            if (editUserModalElement) {
                editUserModalElement.addEventListener('click', (event) => { if (event.target === editUserModalElement) closeEditUserModal(); });
            } else { console.error("Could not find 'editUserModal'."); }

            // Topic Modal Listeners
            document.getElementById('closeTopicModalBtnTop').addEventListener('click', closeEditTopicModal);
            document.getElementById('closeTopicModalBtn').addEventListener('click', closeEditTopicModal);
            document.getElementById('saveTopicChangesBtn').addEventListener('click', saveTopicChanges);
            const editTopicModalElement = document.getElementById('editTopicModal');
            if (editTopicModalElement) {
                editTopicModalElement.addEventListener('click', (event) => { if (event.target === editTopicModalElement) closeEditTopicModal(); });
            } else { console.error("Could not find 'editTopicModal'."); }

            // NEW: Algorithm Modal Listeners
            document.getElementById('closeAlgorithmModalBtnTop').addEventListener('click', closeEditAlgorithmModal);
            document.getElementById('closeAlgorithmModalBtn').addEventListener('click', closeEditAlgorithmModal);
            document.getElementById('saveAlgorithmChangesBtn').addEventListener('click', saveAlgorithmChanges);
            const editAlgorithmModalElement = document.getElementById('editAlgorithmModal');
            if (editAlgorithmModalElement) {
                editAlgorithmModalElement.addEventListener('click', (event) => { if (event.target === editAlgorithmModalElement) closeEditAlgorithmModal(); });
            } else { console.error("Could not find 'editAlgorithmModal'."); }

            // Achievement Modal Listeners
            document.getElementById('closeAchievementModalBtnTop').addEventListener('click', closeEditAchievementModal);
            document.getElementById('closeAchievementModalBtn').addEventListener('click', closeEditAchievementModal);
            document.getElementById('saveAchChangesBtn').addEventListener('click', saveAchievementChanges);
            const editAchievementModalElement = document.getElementById('editAchievementModal');
            if (editAchievementModalElement) {
                editAchievementModalElement.addEventListener('click', (event) => { if (event.target === editAchievementModalElement) closeEditAchievementModal(); });
            } else { console.error("Could not find 'editAchievementModal'."); }

            // --- Add Sort Click Listener ---
            const usersTableHead = document.querySelector('#users table thead');
            if (usersTableHead) {
                usersTableHead.addEventListener('click', handleSortClick);
            } else {
                console.error("Could not find users table head to attach sort listener.");
            }
            // --- End Add Sort Click Listener ---

            // User Search Listener
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        // Pass current sort order when searching
                        loadUsers(1, searchInput.value.trim(), currentUserSortBy, currentUserSortOrder);
                    }, 400);
                });
            } else { console.warn("Could not find 'userSearchInput'."); }

            // User Topic Management Modal Listeners
            document.getElementById('closeUserTopicsModalBtnTop').addEventListener('click', closeManageUserTopicsModal);
            document.getElementById('closeUserTopicsModalBtn').addEventListener('click', closeManageUserTopicsModal);
            const manageUserTopicsModalElement = document.getElementById('manageUserTopicsModal');
            if (manageUserTopicsModalElement) {
                manageUserTopicsModalElement.addEventListener('click', (event) => {
                    if (event.target === manageUserTopicsModalElement) closeManageUserTopicsModal();
                });
            } else { console.error("Could not find 'manageUserTopicsModal'."); }

            // --- Initial Navigation ---
            window.addEventListener('hashchange', handleNavigation);
            handleNavigation(); // Load section based on initial hash or default
            console.log("ADMIN PAGE: Initial navigation complete.");
        });
    </script>
</body>


</html>

