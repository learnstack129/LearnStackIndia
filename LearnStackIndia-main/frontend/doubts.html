<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doubts Forum - LearnStackIndia</title>
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'light'; 
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: {} } };
    </script>
    <style>
        body { background-color: #f1f5f9; }
        .dark body { background-color: #0f172a; }
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .input-field {
            padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #ffffff; color: #111827; width: 100%;
        }
        .dark .input-field { border-color: #4b5563; background-color: #374151; color: #f9fafb; }
        .btn-primary {
            padding: 0.5rem 1rem; background-color: #2563eb; color: white;
            font-weight: 500; border-radius: 0.375rem; transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .doubt-card.resolved { border-left-color: #10b981; }
        .reply-card.mentor { background-color: #fef3c7; border-left-color: #f59e0b; }
        .dark .reply-card.mentor { background-color: #4a3a1a; border-left-color: #f59e0b; }
    </style>
</head>
<body class="dark:bg-gray-900">

    <nav class="bg-white dark:bg-gray-800 shadow-md relative z-10 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="dashboard.html" class="flex items-center">
                    <div class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        <i class="fas fa-code mr-2 text-blue-600"></i>
                        LearnStackIndia
                    </div>
                </a>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="themeToggle" class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300">
                        <i id="themeIcon" class="fas fa-moon text-lg"></i>
                    </button>
                    <button id="logoutBtn" class="bg-red-500 text-white px-2 py-2 sm:px-4 rounded-lg hover:bg-red-600 transition-all duration-300 font-medium">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white" id="subjectTitle">Doubts Forum</h1>
            <a href="dashboard.html" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-500 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        <section id="askDoubtSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Ask a New Question</h2>
            <form id="doubtForm" class="space-y-4">
                <div>
                    <label for="doubtTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title*</label>
                    <input type="text" id="doubtTitle" required class="input-field" placeholder="A brief title for your doubt...">
                </div>
                <div>
                    <label for="doubtText" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question*</label>
                    <textarea id="doubtText" rows="4" required class="input-field" placeholder="Describe your doubt in detail..."></textarea>
                </div>
                <p id="doubtError" class="text-red-500 text-sm h-4"></p>
                <div class="text-right">
                    <button id="submitDoubtBtn" type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane mr-2"></i>Post Question
                    </button>
                </div>
            </form>
        </section>

        <section id="doubtsListContainer" class="space-y-6">
            <div class="loading-skeleton h-32 rounded-lg"></div>
            <div class="loading-skeleton h-48 rounded-lg"></div>
        </section>
    </main>

    <script>
        const API_BASE_URL = '/api';
        let currentSubject = '';
        let currentUser = null;

        // --- Auth & API ---
        function getAuthToken() { return localStorage.getItem('authToken'); }
        function redirectToAuth() {
            localStorage.clear();
            window.location.href = 'auth.html';
        }
        function getCurrentUser() {
            try { return JSON.parse(localStorage.getItem('currentUser')); }
            catch (e) { return null; }
        }
        
        async function makeApiCall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) { redirectToAuth(); return null; }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers },
                    ...options
                });
                const data = await response.json();
                if (response.status === 401) { redirectToAuth(); return null; }
                if (!response.ok) throw new Error(data.message || 'API Error');
                return data;
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                alert(`Error: ${error.message}`);
                return null;
            }
        }

        // --- Theme ---
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            let currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme);
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                localStorage.setItem('theme', currentTheme);
            });
            function applyTheme(theme) {
                html.classList.toggle('dark', theme === 'dark');
                themeIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'} text-lg`;
            }
        }
        
        // --- Doubt Rendering ---
        
        function renderDoubts(doubts) {
            const container = document.getElementById('doubtsListContainer');
            container.innerHTML = ''; // Clear loading
            
            if (doubts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No doubts posted for this subject yet. Be the first!</p>';
                return;
            }
            
            doubts.forEach(doubt => {
                const doubtCard = createDoubtCard(doubt);
                container.appendChild(doubtCard);
            });
        }
        
        function createDoubtCard(doubt) {
            const card = document.createElement('div');
            const isResolved = doubt.isResolved;
            card.className = `doubt-card bg-white dark:bg-gray-800 rounded-lg shadow-md border-l-4 ${isResolved ? 'border-green-500' : 'border-blue-500'} p-5`;
            card.id = `doubt-${doubt._id}`;

            const postedDate = new Date(doubt.createdAt).toLocaleString();
            const canResolve = !isResolved && (currentUser.role !== 'user' || currentUser.id === doubt.postedBy._id);

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${doubt.title}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Asked by ${doubt.postedBy.username} on ${postedDate}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${isResolved ? `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"><i class="fas fa-check mr-1"></i>Resolved</span>` : ''}
                        ${canResolve ? `<button onclick="markResolved('${doubt._id}')" class="btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Mark as Resolved"><i class="fas fa-check"></i></button>` : ''}
                    </div>
                </div>
                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap mb-4">${doubt.questionText}</p>
                <div id="replies-${doubt._id}" class="space-y-3 mt-4 border-t dark:border-gray-600 pt-4">
                    ${doubt.replies.map(createReplyCard).join('')}
                </div>
                ${currentUser.role !== 'user' ? createReplyForm(doubt._id) : ''}
            `;
            return card;
        }

        function createReplyCard(reply) {
            const postedDate = new Date(reply.createdAt).toLocaleString();
            const isMentor = reply.postedBy.role !== 'user';
            return `
                <div class="reply-card flex gap-3 p-3 rounded-lg border-l-4 ${isMentor ? 'mentor bg-yellow-50 dark:bg-yellow-900/30 border-yellow-400' : 'bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-500'}">
                    <img src="${reply.postedBy.profile?.avatar || 'https://placeholder-image-service.onrender.com/image/40x40'}" alt="${reply.postedBy.username}" class="w-10 h-10 rounded-full flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-semibold text-sm text-gray-800 dark:text-white">
                            ${reply.postedBy.username} ${isMentor ? '<span class="text-xs font-medium text-yellow-600 dark:text-yellow-400">(Mentor)</span>' : ''}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">${postedDate}</p>
                        <p class="text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap">${reply.text}</p>
                    </div>
                </div>
            `;
        }
        
        function createReplyForm(doubtId) {
            // Only mentors see this form
            return `
                <form data-doubt-id="${doubtId}" class="reply-form mt-4 space-y-2">
                    <textarea class="input-field text-sm" rows="2" placeholder="Write your answer..." required></textarea>
                    <div class="text-right">
                        <button type="submit" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                            <i class="fas fa-reply mr-1"></i>Post Reply
                        </button>
                    </div>
                </form>
            `;
        }

        // --- Actions ---

        async function loadDoubts() {
            const params = new URLSearchParams(window.location.search);
            currentSubject = params.get('subject');
            if (!currentSubject) {
                alert('No subject specified!');
                window.location.href = 'dashboard.html';
                return;
            }
            
            document.getElementById('subjectTitle').textContent = `${currentSubject} Doubts`;
            
            const data = await makeApiCall(`/doubts?subject=${encodeURIComponent(currentSubject)}`);
            if (data && data.success) {
                renderDoubts(data.doubts);
            }
        }
        
        async function handleDoubtSubmit(e) {
            e.preventDefault();
            const title = document.getElementById('doubtTitle').value.trim();
            const text = document.getElementById('doubtText').value.trim();
            const errorP = document.getElementById('doubtError');
            const submitBtn = document.getElementById('submitDoubtBtn');
            
            if (!title || !text) {
                errorP.textContent = 'Title and Question are required.';
                return;
            }
            
            errorP.textContent = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Posting...';
            
            const data = await makeApiCall('/doubts', {
                method: 'POST',
                body: JSON.stringify({ title: title, questionText: text, subject: currentSubject })
            });
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Post Question';

            if (data && data.success) {
                const newDoubtCard = createDoubtCard(data.doubt);
                const container = document.getElementById('doubtsListContainer');
                // If it's the first doubt, clear the "no doubts" message
                if (container.querySelector('p')) {
                    container.innerHTML = '';
                }
                container.prepend(newDoubtCard); // Add new doubt to the top
                document.getElementById('doubtForm').reset();
            } else {
                errorP.textContent = data.message || 'Failed to post doubt.';
            }
        }
        
        async function handleReplySubmit(e) {
            e.preventDefault();
            const form = e.target;
            const doubtId = form.dataset.doubtId;
            const textarea = form.querySelector('textarea');
            const button = form.querySelector('button');
            const text = textarea.value.trim();
            
            if (!text) return;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const data = await makeApiCall(`/doubts/${doubtId}/reply`, {
                method: 'POST',
                body: JSON.stringify({ text: text })
            });
            
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-reply mr-1"></i>Post Reply';
            
            if (data && data.success) {
                const newReplyCard = createReplyCard(data.reply);
                document.getElementById(`replies-${doubtId}`).appendChild(newReplyCard);
                textarea.value = '';
            }
        }
        
        async function markResolved(doubtId) {
            if (!confirm('Are you sure you want to mark this doubt as resolved?')) return;
            
            const data = await makeApiCall(`/doubts/${doubtId}/resolve`, { method: 'PUT' });
            if (data && data.success) {
                alert('Doubt marked as resolved.');
                loadDoubts(); // Simple refresh
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!getAuthToken()) { redirectToAuth(); return; }
            currentUser = getCurrentUser();
            if (!currentUser) { redirectToAuth(); return; }

            initializeTheme();
            document.getElementById('logoutBtn').addEventListener('click', redirectToAuth);
            
            // Hide "Ask Doubt" section for mentors
            if (currentUser.role !== 'user') {
                document.getElementById('askDoubtSection').classList.add('hidden');
            }
            
            document.getElementById('doubtForm').addEventListener('submit', handleDoubtSubmit);
            
            // Add event listener for reply forms (uses event delegation)
            document.getElementById('doubtsListContainer').addEventListener('submit', (e) => {
                if (e.target.classList.contains('reply-form')) {
                    handleReplySubmit(e);
                }
            });

            loadDoubts();
        });
    </script>
</body>
</html>
